<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Globale Variablen definieren -->
    <script>
        // Avatar-Map für Benutzerbilder
        const avatarMap = {
            'admin': 'https://randomuser.me/api/portraits/men/1.jpg',
            'petra': 'https://randomuser.me/api/portraits/women/2.jpg',
            'jürgen': 'https://randomuser.me/api/portraits/men/3.jpg',
            'nizia': 'https://randomuser.me/api/portraits/women/4.jpg',
            'fatih': 'https://randomuser.me/api/portraits/men/5.jpg',
            'silas': 'https://randomuser.me/api/portraits/men/6.jpg',
            'julian': 'https://randomuser.me/api/portraits/men/7.jpg'
        };
        
        // Globale Chart-Variablen
        window.revenueChart = null;
        window.monthlySalesChart = null;
        window.marginTrendChart = null;
        
        // Dashboard-Funktionen
        function toggleDashboard() {
            const modal = document.getElementById('dashboardModal');
            if (modal.style.display === 'none' || modal.style.display === '') {
                modal.style.display = 'block';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.zIndex = '2000';
                modal.style.paddingTop = '50px';
                modal.classList.remove('fade');
                modal.classList.add('show');
                
                // Daten laden
                loadDashboardData();
                
                // Auch die Kundendaten vorausladen
                loadCustomerData();
                
                // Tab-Funktionalität initialisieren
                const tabButtons = document.querySelectorAll('#dashboardTabs .nav-link');
                tabButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        console.log("Tab clicked:", this.getAttribute('data-bs-target'));
                        
                        // Alle Tabs deaktivieren
                        document.querySelectorAll('#dashboardTabs .nav-link').forEach(tab => {
                            tab.classList.remove('active');
                        });
                        document.querySelectorAll('.tab-pane').forEach(pane => {
                            pane.classList.remove('show', 'active');
                        });
                        
                        // Aktiven Tab setzen
                        this.classList.add('active');
                        const target = document.querySelector(this.getAttribute('data-bs-target'));
                        if (target) {
                            target.classList.add('show', 'active');
                            
                            // Wenn der Kundenauswertungs-Tab geöffnet wird, lade die Kundendaten
                            if (this.getAttribute('data-bs-target') === '#customer') {
                                console.log("Kundenanalyse Tab aktiviert - lade Daten...");
                                loadCustomerData().catch(error => {
                                    console.error("Fehler beim Laden der Kundenanalyse:", error);
                                });
                            }
                        } else {
                            console.error("Tab target not found:", this.getAttribute('data-bs-target'));
                        }
                    });
                });
                
                // Overview-Tab standardmäßig aktivieren
                const overviewTab = document.getElementById('overview-tab');
                if (overviewTab) {
                    overviewTab.classList.add('active');
                    const overviewPane = document.getElementById('overview');
                    if (overviewPane) {
                        overviewPane.classList.add('show', 'active');
                    }
                }
            } else {
                modal.style.display = 'none';
                modal.classList.remove('show');
                
                // Charts beim Schließen zerstören
                if (window.revenueChart) {
                    window.revenueChart.destroy();
                    window.revenueChart = null;
                }
                if (window.monthlySalesChart) {
                    window.monthlySalesChart.destroy();
                    window.monthlySalesChart = null;
                }
                if (window.marginTrendChart) {
                    window.marginTrendChart.destroy();
                    window.marginTrendChart = null;
                }
            }
        }
    
    // Hilfe-Dialog-Funktion
    function toggleHilfeDialog() {
        const modal = document.getElementById('hilfeModal');
        if (modal.style.display === 'none' || modal.style.display === '') {
            modal.style.display = 'block'; 
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.style.zIndex = '2000';
            modal.style.paddingTop = '50px';
            modal.classList.remove('fade');
            modal.classList.add('show');
        } else {
            modal.style.display = 'none';
            modal.classList.remove('show');
        }
    }
        
        // Dashboard-Daten laden
        async function loadDashboardData() {
            try {
                console.log("Dashboard-Daten werden geladen...");
                
                // Bestehende Charts zerstören
                if (window.revenueChart) {
                    window.revenueChart.destroy();
                    window.revenueChart = null;
                }
                if (window.monthlySalesChart) {
                    window.monthlySalesChart.destroy();
                    window.monthlySalesChart = null;
                }
                if (window.marginTrendChart) {
                    window.marginTrendChart.destroy();
                    window.marginTrendChart = null;
                }
                
                const API_URL = 'http://192.168.1.20:5050/api/kalkulationen';
                const response = await fetch(API_URL);
                const data = await response.json();

                if (!data || data.length === 0) {
                    document.getElementById('totalCalculations').textContent = "0";
                    document.getElementById('totalRevenue').textContent = "0,00 €";
                    document.getElementById('averageMargin').textContent = "0,0%";
                    document.getElementById('uniqueCustomers').textContent = "0";
                    return;
                }

                // Artikel-Array erstellen
                let artikelArray = [];
                data.forEach(kalk => {
                    if (kalk.artikel && Array.isArray(kalk.artikel)) {
                        artikelArray = artikelArray.concat(kalk.artikel);
                    } else if (typeof kalk === 'object') {
                        artikelArray.push(kalk);
                    }
                });

                // KPIs berechnen
                const totalCalculations = data.length;
                let totalRevenue = 0;
                let totalMargin = 0;
                const customers = new Set();

                artikelArray.forEach(art => {
                    const verkaufssumme = parseFloat(art.verkaufssumme || art.gesamtVK || 0) || 0;
                    const dbGesamt = parseFloat(art.db_gesamt || art.dbGesamt || 0) || 0;
                    
                    totalRevenue += verkaufssumme;
                    totalMargin += dbGesamt;
                    
                    if (art.kundenname) {
                        customers.add(art.kundenname);
                    }
                });

                const avgMarginPercent = totalRevenue > 0 ? (totalMargin / totalRevenue) * 100 : 0;

                // KPIs aktualisieren
                document.getElementById('totalCalculations').textContent = totalCalculations;
                document.getElementById('totalRevenue').textContent = formatCurrencyNoDecimals(totalRevenue);
                document.getElementById('averageMargin').textContent = `${avgMarginPercent.toFixed(1)}%`;
                document.getElementById('uniqueCustomers').textContent = customers.size;

                // Monatliche Daten berechnen
                const monthlyData = Array(12).fill().map(() => ({
                    revenue: 0,
                    margin: 0,
                    count: 0
                }));

                data.forEach(kalk => {
                    if (kalk.artikel && Array.isArray(kalk.artikel)) {
                        let month;
                        try {
                            const date = new Date(kalk.datum || kalk.erstelldatum);
                            if (!isNaN(date.getTime())) {
                                month = date.getMonth();
                            } else {
                                console.warn('Ungültiges Datum:', kalk.datum || kalk.erstelldatum);
                                month = new Date().getMonth(); // Fallback auf aktuellen Monat
                            }
                        } catch (e) {
                            console.warn('Fehler bei der Datumsverarbeitung:', e);
                            month = new Date().getMonth(); // Fallback auf aktuellen Monat
                        }
                        
                        if (month >= 0 && month < 12) {
                            kalk.artikel.forEach(art => {
                                const verkaufssumme = parseFloat(art.verkaufssumme || art.gesamtVK || 0) || 0;
                                const dbGesamt = parseFloat(art.db_gesamt || art.dbGesamt || 0) || 0;
                                
                                monthlyData[month].revenue += verkaufssumme;
                                monthlyData[month].margin += dbGesamt;
                                monthlyData[month].count++;
                            });
                        }
                    }
                });

                // Margen-Prozentsätze berechnen
                const marginPercentages = monthlyData.map(month => 
                    month.revenue > 0 ? (month.margin / month.revenue) * 100 : 0
                );

                // Umsatz-Chart
                const revenueCtx = document.getElementById('revenueChart').getContext('2d');
                window.revenueChart = new Chart(revenueCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'],
                        datasets: [{
                            label: 'Umsatz',
                            data: monthlyData.map(m => m.revenue),
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Monatlicher Umsatz'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Umsatz: ${formatCurrency(context.parsed.y)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Umsatz (€)'
                                }
                            }
                        }
                    }
                });

                // Margenentwicklung Chart
                try {
                    const marginCtx = document.getElementById('marginTrendChart');
                    if (!marginCtx) {
                        console.error('marginTrendChart Canvas nicht gefunden');
                        return;
                    }

                    if (window.marginTrendChart) {
                        window.marginTrendChart.destroy();
                    }

                    window.marginTrendChart = new Chart(marginCtx, {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'],
                            datasets: [{
                                label: 'Marge (%)',
                                data: marginPercentages,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Margenentwicklung nach Monat'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `Marge: ${context.parsed.y.toFixed(1)}%`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Marge (%)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Fehler beim Erstellen des Margenentwicklung-Charts:', error);
                }

                // Top 5 Kunden
                const customerRevenues = {};
                artikelArray.forEach(art => {
                    if (!art.kundenname) return;
                    
                    const verkaufssumme = parseFloat(art.verkaufssumme || art.gesamtVK || 0) || 0;
                    
                    if (!customerRevenues[art.kundenname]) {
                        customerRevenues[art.kundenname] = 0;
                    }
                    customerRevenues[art.kundenname] += verkaufssumme;
                });

                const sortedCustomers = Object.entries(customerRevenues)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                const topCustomersContainer = document.getElementById('topCustomers');
                if (topCustomersContainer) {
                    topCustomersContainer.innerHTML = '';
                    
                    if (sortedCustomers.length === 0) {
                        const emptyItem = document.createElement('a');
                        emptyItem.href = '#';
                        emptyItem.className = 'list-group-item list-group-item-action';
                        emptyItem.textContent = 'Keine Kundendaten verfügbar';
                        topCustomersContainer.appendChild(emptyItem);
                    } else {
                        sortedCustomers.forEach(([customer, revenue]) => {
                            const item = document.createElement('a');
                            item.href = '#';
                            item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                            item.innerHTML = `
                                <span>${customer}</span>
                                <span class="badge bg-primary rounded-pill">${formatCurrency(revenue)}</span>
                            `;
                            topCustomersContainer.appendChild(item);
                        });
                    }
                }

                // Nach dem Margenentwicklung Chart:

                // Monatliche Verkäufe Chart
                try {
                    const salesCtx = document.getElementById('monthlySalesChart');
                    if (!salesCtx) {
                        console.error('monthlySalesChart Canvas nicht gefunden');
                        return;
                    }

                    if (window.monthlySalesChart) {
                        window.monthlySalesChart.destroy();
                    }

                    window.monthlySalesChart = new Chart(salesCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'],
                            datasets: [{
                                label: 'Verkäufe',
                                data: monthlyData.map(m => m.count),
                                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Anzahl Verkäufe pro Monat'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const month = context.dataIndex;
                                            const count = monthlyData[month].count;
                                            const revenue = monthlyData[month].revenue;
                                            return [
                                                `Anzahl: ${count}`,
                                                `Umsatz: ${formatCurrency(revenue)}`
                                            ];
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Anzahl Verkäufe'
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Fehler beim Erstellen des Verkäufe-Charts:', error);
                }

            } catch (error) {
                console.error("Fehler beim Laden der Dashboard-Daten:", error);
                
                document.getElementById('totalCalculations').textContent = "-";
                document.getElementById('totalRevenue').textContent = "-";
                document.getElementById('averageMargin').textContent = "-";
                document.getElementById('uniqueCustomers').textContent = "-";
            }
        }
    
    // Neue Funktion zum Laden der Kundendaten für die Kundenauswertung
    async function loadCustomerData() {
        try {
            console.log("Kundendaten werden geladen...");
            const API_URL = 'http://192.168.1.20:5050/api/kalkulationen';
            
            const response = await fetch(API_URL);
            if (!response.ok) {
                throw new Error(`HTTP-Fehler! Status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log("Daten für Kundenauswertung empfangen:", data.length, "Datensätze");
            
            // Kundenstatistiken initialisieren
            const customerStats = {};
            
            // Daten pro Kunde aggregieren
            data.forEach((kalk, index) => {
                try {
                    // Extrahiere den Kundennamen aus dem ersteller Feld
                    const ersteller = kalk.ersteller;
                    if (!ersteller) {
                        console.log(`Überspringe Datensatz ${index} - kein Ersteller gefunden:`, kalk);
                        return;
                    }
                    
                    // Ersteller als Kundenname verwenden
                    const kundenname = ersteller;
                    
                    if (!customerStats[kundenname]) {
                        customerStats[kundenname] = {
                            calculations: 0,
                            revenue: 0,
                            margin: 0,
                            lastDate: null
                        };
                    }
                    
                    const stats = customerStats[kundenname];
                    stats.calculations++;
                    
                    // Datum aus dem datum Feld extrahieren
                    const datumMatch = kalk.datum?.match(/\d{4}-\d{2}-\d{2}/);
                    const kalkDate = datumMatch ? new Date(datumMatch[0]) : new Date();
                    
                    if (!stats.lastDate || kalkDate > stats.lastDate) {
                        stats.lastDate = kalkDate;
                    }
                    
                    // Verkaufssumme und Marge aus den Artikeln
                    if (kalk.artikel && Array.isArray(kalk.artikel)) {
                        kalk.artikel.forEach((art, artIndex) => {
                            const verkaufssumme = parseFloat(art.verkaufssumme || art.gesamtVK || 0) || 0;
                            const dbGesamt = parseFloat(art.db_gesamt || art.dbGesamt || 0) || 0;
                            
                            stats.revenue += verkaufssumme;
                            stats.margin += dbGesamt;
                        });
                    }
                } catch (kalkulationError) {
                    console.error(`Fehler bei der Verarbeitung von Kalkulation ${index}:`, kalkulationError);
                }
            });
            
            // Tabelle aktualisieren
            const tableBody = document.getElementById('customerTableBody');
            if (!tableBody) {
                console.error("Tabellenkörper nicht gefunden");
                return;
            }
            
            // Prüfen ob Daten vorhanden sind
            if (Object.keys(customerStats).length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Keine Kundendaten verfügbar</td></tr>';
                return;
            }
            
            tableBody.innerHTML = '';
            
            // Kunden nach Umsatz sortieren
            Object.entries(customerStats)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .forEach(([customer, stats]) => {
                    const row = document.createElement('tr');
                    const marginPercent = stats.revenue > 0 ? (stats.margin / stats.revenue) * 100 : 0;
                    
                    row.innerHTML = `
                        <td>${customer}</td>
                        <td class="text-center">${stats.calculations}</td>
                        <td class="text-end">${formatCurrency(stats.revenue)}</td>
                        <td class="text-end">${marginPercent.toFixed(1)}%</td>
                        <td class="text-center">${stats.lastDate ? formatDate(stats.lastDate) : '-'}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
        } catch (error) {
            console.error('Fehler beim Laden der Kundendaten:', error);
            const tableBody = document.getElementById('customerTableBody');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger">
                            Fehler beim Laden der Daten: ${error.message}
                        </td>
                    </tr>`;
            }
        }
    }
    
    // Hilfsfunktion für Währungsformatierung
    function formatCurrency(value) {
        return new Intl.NumberFormat('de-DE', { 
            style: 'currency', 
            currency: 'EUR',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);
    }
    
    // Hilfsfunktion für Währungsformatierung ohne Nachkommastellen
    function formatCurrencyNoDecimals(value) {
        return new Intl.NumberFormat('de-DE', { 
            style: 'currency', 
            currency: 'EUR',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(value);
    }
    
    // Hilfsfunktion für Datumsformatierung
    function formatDate(date) {
        try {
            if (!date) return '-';
            
            // Sicherstellen, dass es ein Date-Objekt ist
            let dateObj;
            if (!(date instanceof Date)) {
                dateObj = new Date(date);
            } else {
                dateObj = date;
            }
            
            // Bei ungültigem Datum Strich zurückgeben
            if (isNaN(dateObj.getTime())) {
                return '-';
            }
            
            // Datum im deutschen Format (TT.MM.JJJJ) ausgeben
            return dateObj.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        } catch (e) {
            console.error("Fehler bei der Datumsformatierung:", e);
            return '-';
            }
        }
    </script>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Chart.js für Diagramme -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            text-align: center;
            color: #003366;
            font-weight: bold;
        }
        .spinner-border {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }
        @keyframes spinner-border {
            100% { transform: rotate(360deg); }
        }
    </style>
    <style>
        :root {
            --primary-color: #003366;
            --secondary-color: #009999;
            --accent-color: #FFB900;
            --background-color: #f8f9fa;
            --text-color: #333;
        }
        body {
            background-color: #fff;
            color: var(--text-color);
            font-family: '72', 'Segoe UI', Arial, sans-serif;
            font-size: 0.98rem;
            visibility: hidden;
        }
        .navbar {
            background-color: #003366 !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 64px;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        .navbar-brand img {
            height: 40px;
            margin-right: 12px;
        }
        .navbar-brand span {
            font-size: 1.13rem;
            font-weight: 700;
            color: #fff;
            margin-left: 0;
        }
        #userInfo {
            gap: 10px;
            margin-left: 32px;
        }
        #userAvatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        #userName {
            font-weight: 500;
            color: #fff;
            font-family: '72', 'Segoe UI', Arial, sans-serif;
        }
        .container-box {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            padding: 1rem 0.3rem 0.8rem 0.3rem; /* Reduziertes seitliches Padding */
            margin-top: 0.7rem;
            margin-bottom: 0.7rem;
            width: 1400px; /* Breitere feste Breite */
            margin-left: 0; /* Kein linker Rand */
            margin-right: auto;
        }
        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: #fff;
        }
        .nav-tabs .nav-link {
            color: var(--primary-color);
        }
        .tab-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 24px;
            margin-top: 16px;
        }
        .action-button, .btn-primary, .pdf-button, .reset-button {
            background-color: var(--primary-color) !important;
            color: #fff !important;
            border: none;
            border-radius: 6px !important;
            font-weight: 500;
            font-size: 0.98rem;
            padding: 6px 16px;
            box-shadow: none;
            transition: background 0.18s;
        }
        .action-button:hover, .btn-primary:hover, .pdf-button:hover {
            background-color: var(--secondary-color) !important;
            color: #fff !important;
        }
        .reset-button {
            background: #dc2626 !important;
        }
        .reset-button:hover {
            background: #b91c1c !important;
        }
        input, select, textarea {
            border-radius: 5px !important;
            border: 1.2px solid #bfc9d1;
            font-size: 0.98rem;
            padding: 5px 8px;
            background: #fff;
            transition: border 0.18s, box-shadow 0.18s;
        }
        input:focus, select:focus, textarea:focus {
            border: 1.2px solid var(--primary-color);
            box-shadow: 0 0 0 1.5px #00336622;
            outline: none;
        }
        .form-section {
            border-radius: 7px;
            border: 1px solid #e3e8ee;
            box-shadow: none;
            background: #f9fbfd;
            padding: 14px 10px 8px 10px;
            margin-bottom: 0;
        }
        .form-section legend {
            font-weight: 600;
            color: #1a3b6e;
            font-size: 1.08rem;
            letter-spacing: 0.3px;
        }
        /* Entfernt die Pfeile in Zahleneingabefeldern */
        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .main-flex-container {
            display: flex;
            align-items: flex-start;
            justify-content: flex-start; /* Linksbündige Ausrichtung */
            width: 1400px; /* Breitere feste Breite */
            margin-top: 30px; /* Abstand für die Tab-Bar */
            margin-left: 0; /* Kein linker Rand */
            margin-right: auto;
            padding-left: 0; /* Kein linker Innenabstand */
            min-height: calc(100vh - 180px); /* Mindesthöhe, die den verfügbaren Platz im Viewport nutzt */
            padding-bottom: 30px; /* Zusätzlicher Abstand am unteren Rand */
        }
        .button-leiste {
            min-width: 175px; /* Noch schmalere Button-Leiste */
            margin-right: 15px; /* Noch geringerer Abstand */
            margin-top: 0;
            max-width: 175px; /* Noch schmalere fixe Breite */
            margin-left: 0; /* Kein linker Abstand */
            padding-left: 0; /* Kein linker Innenabstand */
        }
        .main-flex-container > div:not(.button-leiste) {
            width: 1210px; /* Feste Breite (1400px - 190px für Button-Leiste und Abstand) */
            padding-left: 0; /* Kein linker Innenabstand */
        }
        @media (max-width: 1400px) {
            .container-box { padding: 1rem; width: 95%; min-width: 950px; margin-left: 0; margin-right: auto; }
            .main-flex-container { width: 95%; min-width: 950px; margin-left: 0; margin-right: auto; }
            .main-flex-container > div:not(.button-leiste) { width: calc(100% - 260px); min-width: 690px; }
        }
        @media (max-width: 900px) {
            .container-box { padding: 1rem; width: 95%; min-width: 700px; margin-left: 0; }
            .main-flex-container { flex-direction: column; width: 95%; min-width: 700px; margin-left: 0; }
            .button-leiste { margin-right: 0; margin-bottom: 18px; max-width: 100%; width: 100%; }
            .main-flex-container > div:not(.button-leiste) { width: 100%; min-width: 700px; }
        }
        .button-row {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 18px;
            margin-left: 60px;
        }
        .button-row button {
            background: linear-gradient(90deg, #1a3b6e 60%, #009999 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.02rem;
            padding: 10px 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: background 0.18s, box-shadow 0.18s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .button-row button:hover {
            background: linear-gradient(90deg, #009999 60%, #1a3b6e 100%);
            box-shadow: 0 4px 16px rgba(0,0,0,0.13);
        }
        .button-row i {
            font-size: 1.1em;
        }
        .button-row-oben {
            display: flex;
            flex-direction: column;
            gap: 0;
            align-items: flex-start;
            width: 175px;
            margin-left: 0;
            margin-top: 0;
        }
        .button-row-oben a,
        .button-row-oben button {
            display: block;
            width: 100%;
            min-width: 160px;
            max-width: 100%;
            box-sizing: border-box;
            margin: 0;
            text-align: left;
            font-size: 0.98rem;
            font-weight: 600;
            padding: 10px 16px;
            border-radius: 7px;
            background: linear-gradient(90deg, #1a3b6e 60%, #009999 100%);
            color: #fff;
            border: none;
            box-shadow: 0 1px 4px 0 rgba(0,0,0,0.07);
            letter-spacing: 0.3px;
            transition: background 0.2s;
            cursor: pointer;
        }
        .button-row-oben a:hover,
        .button-row-oben button:hover {
            background: linear-gradient(90deg, #009999 60%, #1a3b6e 100%);
        }
        .button-row-oben .reset-button {
            background: #dc2626;
        }
        .button-row-oben .reset-button:hover {
            background: #b91c1c;
        }
        .button-row-oben .pdf-button {
            background: #1a3b6e;
        }
        .button-row-oben .pdf-button:hover {
            background: #2c5282;
        }
        .table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            font-size: 1.08em;
        }
        .table thead th {
            background-color: var(--primary-color);
            color: white;
            border: none;
            font-size: 1.08em;
        }
        .table tbody tr:hover {
            background-color: #eaf3fc;
        }
        .summary-box {
            background: var(--accent-color);
            color: #333;
            border-radius: 10px;
            padding: 18px;
            font-size: 1.18rem;
            font-weight: 600;
            margin-bottom: 18px;
        }
        .version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 13px;
            color: #718096;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.10);
        }
        @media (max-width: 1400px) {
            .container-box { padding: 1rem; width: 95%; min-width: 950px; }
            .main-flex-container { width: 95%; min-width: 950px; }
        }
        @media (max-width: 900px) {
            .container-box { padding: 1rem; width: 95%; min-width: 700px; }
            .main-flex-container { flex-direction: column; width: 95%; min-width: 700px; }
            .button-leiste { margin-right: 0; margin-bottom: 18px; }
        }
        .kalk-flex {
            display: flex;
            gap: 15px; /* Reduzierter Abstand zwischen Karten */
            justify-content: space-between; /* Karten gleichmäßig verteilen */
            align-items: flex-start;
            flex-wrap: nowrap; /* Immer in einer Reihe darstellen */
            margin-bottom: 18px;
            width: 100%; /* Volle Breite für den Container */
        }
        .kalk-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.10);
            border: 1px solid #e3e8ee;
            padding: 15px 10px 12px 10px; /* Noch kleinere seitliche Innenabstände */
            min-width: 200px; /* Minimale Breite reduziert */
            flex: 1 1 0;
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
            gap: 8px; /* Kleinerer Abstand zwischen Elementen */
            height: 100%; /* Gleiche Höhe für alle Karten */
            font-size: 0.95rem; /* Kleinere Schriftgröße */
        }
        .kalk-card:nth-child(3) { /* Versand-Card */
            position: relative;
        }
        .kalk-card h3 {
            font-size: 0.9rem; /* Noch kleinere Überschriften */
            font-weight: 600;
            color: #003366;
            margin-bottom: 5px;
            margin-top: 0;
            text-transform: uppercase;
        }
        @media (max-width: 1100px) {
            .kalk-flex { flex-direction: column; gap: 12px; width: 100%; }
            .kalk-card { max-width: 100%; min-width: 0; }
        }
        @media (min-width: 1101px) {
            .kalk-flex { 
                flex-direction: row; 
                flex-wrap: nowrap; 
                justify-content: space-between;
                width: 100%;
            }
            .kalk-card { 
                flex: 1;
                min-width: 220px;
                width: 24%;
                max-width: 24%;
            }
        }
        .kalk-card input,
        .kalk-card select {
            width: 100%;
            margin-bottom: 6px; /* Kleinerer Abstand */
            min-height: 34px; /* Kleinere Höhe */
            font-size: 0.95rem;
        }
        .kalk-card select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23003366' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 30px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1.5px solid #bfc9d1;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: relative; /* Wichtig für das :before-Element */
        }
        .kalk-card select:hover {
            border-color: #1a3b6e;
            background-color: #f5f7fa;
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
        }
        .kalk-card select:focus {
            border-color: #1a3b6e;
            box-shadow: 0 0 0 3px rgba(26, 59, 110, 0.15);
            outline: none;
        }
        /* Stile für moderne Select-Optionen */
        .kalk-card select option {
            padding: 10px;
            background-color: white;
            font-size: 1em;
        }
        /* Gleiche Stil-Anpassungen für das Versandart-Dropdown */
        #versandartSelect {
            background-color: white;
        }
        /* Verbesserte Labels für Dropdowns */
        .kalk-card label {
            margin-bottom: 8px;
            display: block;
            font-weight: 500;
            color: #2c3e50;
        }
        /* Pulseffekt für disabled select */
        .kalk-card select:disabled {
            opacity: 0.6;
            background-color: #f0f4f8;
            border-color: #d0d7de;
            cursor: not-allowed;
        }
        /* Zusätzlicher visueller Hinweis auf auswählbare Elemente - entfernt, da Problem mit position */
        /* Aktive Select-Elemente hervorheben */
        .kalk-card select:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        /* Besondere Stile für Preiseinheiten-Dropdown */
        #preiseinheitSelect option {
            font-weight: 500;
        }
        
        /* Angepasste Dropdown-Stile für Browser, die dies unterstützen */
        @supports ((-webkit-appearance: none) or (-moz-appearance: none)) {
            .kalk-card select option:checked {
                background-color: #e3e8ee;
                color: #1a3b6e;
                font-weight: bold;
            }
        }
        /* Feste Breite für die Kalkulation-Karten */
        .kalk-flex {
            display: flex;
            gap: 15px; /* Reduzierter Abstand zwischen Karten */
            justify-content: flex-start; /* Vom linken Rand aus starten */
            align-items: flex-start;
            flex-wrap: nowrap; /* Immer in einer Reihe darstellen */
            margin-bottom: 18px;
            width: 1210px; /* Breitere feste Breite */
            padding-left: 0; /* Kein linker Innenabstand */
        }
        /* Einheitliche Breite für Datenbank-Tab */
        .w-100 {
            width: 1210px !important;
            padding-left: 0 !important;
            margin-top: 0 !important;
            position: relative !important;
        }
        /* Behalte das Media Query für wirklich kleine Bildschirme */
        @media (max-width: 1400px) {
            .kalk-flex { width: calc(100% - 260px); min-width: 690px; }
        }
        @media (max-width: 1000px) {
            .kalk-flex { flex-direction: column; gap: 12px; width: calc(100% - 50px); min-width: 650px; }
            .kalk-card { max-width: 100%; min-width: 0; width: 100%; }
        }
        @media (min-width: 1001px) {
            .kalk-flex { 
                flex-direction: row; 
                flex-wrap: nowrap; 
                justify-content: flex-start;
                width: 1210px;
            }
            .kalk-card { 
                flex: 1;
                min-width: 200px;
                width: 290px;
                max-width: 290px;
                margin-right: 10px;
            }
        }
        
        /* Container für die Tab-Leiste */
.tab-container {
    width: 100%;
    margin-bottom: 20px;
    border-bottom: 2px solid #c0d0e2;
    padding-left: 0;
    display: flex;
    justify-content: flex-start;
    position: relative;
    z-index: 10;
}
        
        /* Styling für horizontale Tabs */
        .tab-container .nav-tabs {
            display: flex;
            flex-direction: row;
            border-bottom: none;
        }
        
        .tab-container .nav-item {
            margin-right: 5px;
        }
        
        /* Verbesserte Tab-Bar Container Stile */
.tab-bar-container {
    display: flex;
    flex-direction: row;
    margin-bottom: 0;
    width: 100%;
    position: relative;
    border-bottom: 2px solid #c0d0e2;
    padding-bottom: 0;
    background: transparent;
    z-index: 10;
}
        
        /* Styling für Tab-Buttons */
        .tab-bar-container .nav-link {
            display: inline-block;
            width: 170px;
            padding: 12px 16px;
            background: #f0f3f8;
            color: #333;
            font-weight: 600;
            border: 1px solid #d0d7e2;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            text-align: center;
            font-size: 0.95rem;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 6px;
            margin-bottom: 0;
            position: relative;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.03);
        }
        
        .tab-bar-container .nav-link:hover {
            background: #e8edf7;
            color: #1a3b6e;
        }
        
        .tab-bar-container .nav-link.active {
            background: #1a3b6e;
            color: #fff;
            border-color: #1a3b6e;
            box-shadow: 0 -3px 8px rgba(26, 59, 110, 0.2);
            z-index: 2;
        }
        
        .tab-bar-container .nav-link i {
            margin-right: 8px;
        }
        
        /* Medien-Abfragen für die Tab-Leiste */
        @media (max-width: 1400px) {
            .tab-container, .tab-bar-container { 
                width: calc(100% - 260px);
                min-width: 690px;
            }
        }
        @media (max-width: 900px) {
            .tab-container, .tab-bar-container { 
                width: 100%;
                min-width: 700px;
            }
        }
    </style>
    <style>
        /* Hamburger button styling */
        #sidebarToggle {
            border: 1px solid rgba(255,255,255,0.25) !important;
            border-radius: 6px !important;
            padding: 6px 10px !important;
            transition: all 0.2s ease !important;
            background: rgba(255,255,255,0.05) !important;
        }
        
        #sidebarToggle:hover {
            background: rgba(255,255,255,0.15) !important;
            border-color: rgba(255,255,255,0.4) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }
        
        #sidebarToggle i {
            font-size: 1.1rem !important;
            color: #fff !important;
        }

        /* Navbar positioning fix */
        .navbar-brand {
            margin-left: 0 !important;
        }
    </style>
    <style>
        .sidebar {
            position: fixed;
            top: 56px;
            left: 0;
            height: calc(100vh - 56px);
            width: 250px;
            background: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar-menu {
            padding: 0;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
            border-left: 3px solid transparent;
        }

        .sidebar-item:hover {
            background-color: #f0f4f8;
            text-decoration: none;
            color: #1a365d;
        }

        .sidebar-item.active {
            background-color: #1a365d;
            color: #fff;
            border-left-color: #ffd700;
        }

        .sidebar-item i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            font-size: 1.1em;
        }

        .main-content {
            margin-left: 250px;
            padding: 1rem;
            transition: margin-left 0.3s;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }
    </style>
</head>
<body>
    <!-- Zugriffskontrolle -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }

            const userData = JSON.parse(currentUser);
            const hasAccess = userData.role === 'admin' || (userData.rights && userData.rights.includes('Kalkulation.html'));
            
            if (!hasAccess) {
                alert('Sie haben keine Berechtigung, auf diese Seite zuzugreifen.');
                window.location.href = 'index.html';
                return;
            }

            document.body.style.visibility = 'visible';
            
            // Benutzerinformationen aktualisieren
            const userName = userData.name || userData.username;
            const userNameDisplay = userName.charAt(0).toUpperCase() + userName.slice(1);
            
            const userNameSpan = document.getElementById('userName');
            const userAvatar = document.getElementById('userAvatar');
            
            if (userNameSpan) userNameSpan.textContent = userNameDisplay;
            if (userAvatar) userAvatar.src = avatarMap[userName.toLowerCase()] || 'https://randomuser.me/api/portraits/lego/1.jpg';
        });
    </script>

    <!-- Avatar und Benutzername Handling -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = sessionStorage.getItem('currentUser');
            if (currentUser) {
                const userData = JSON.parse(currentUser);
                const userName = userData.name || userData.username;
                const userNameDisplay = userName.charAt(0).toUpperCase() + userName.slice(1);
                
                // Avatar und Name aktualisieren
                const userNameSpan = document.getElementById('userName');
                const userAvatar = document.getElementById('userAvatar');
                
                
                if (userNameSpan) userNameSpan.textContent = userNameDisplay;
                if (userAvatar) userAvatar.src = avatarMap[userName.toLowerCase()] || 'https://randomuser.me/api/portraits/lego/1.jpg';
            }
        });
    </script>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-light" id="sidebarToggle">
                    <i class="bi bi-list"></i>
                </button>
                <a class="navbar-brand d-flex align-items-center mb-0 ms-2" href="#">
                    <img src="LOGO.svg" alt="Hauenstein Verpackungen" style="height: 30px;" />
                    <span class="ms-2">Kalkulation</span>
                </a>
            </div>
            <div class="d-flex align-items-center">
                <button class="btn btn-light me-2" onclick="toggleDashboard()">
                    <i class="bi bi-graph-up"></i> Dashboard
                </button>
                <button id="hilfeBtn" class="btn btn-outline-light me-3" onclick="toggleHilfeDialog()">
                    <i class="bi bi-question-circle"></i>
                </button>
                <div class="d-flex align-items-center">
                    <img id="userAvatar" src="https://randomuser.me/api/portraits/men/1.jpg" alt="User" style="width:32px; height:32px; border-radius:50%; object-fit:cover; border:2px solid #fff; box-shadow:0 1px 4px rgba(0,0,0,0.08);">
                    <span id="userName" style="font-weight:500; color:#fff;" class="ms-2">Benutzer</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="sidebar collapsed" id="sidebar">
        <div class="sidebar-menu">
            <a href="index.html" class="sidebar-item">
                <i class="bi bi-house"></i>
                Startseite
            </a>
            <script>
                // Dynamisches Laden der Menüpunkte basierend auf Benutzerrechten
                document.addEventListener('DOMContentLoaded', function() {
                    const currentUser = sessionStorage.getItem('currentUser');
                    if (!currentUser) return;

                    const userData = JSON.parse(currentUser);
                    const menuItems = {
                        'Kalkulation.html': { icon: 'bi-calculator', text: 'Kalkulation' },
                        'EPS.html': { icon: 'bi-box', text: 'EPS-Berechnung' },
                        'Drucker.html': { icon: 'bi-printer', text: 'Digitaler Verpackungsdruck' },
                        'Plotter.html': { icon: 'bi-scissors', text: 'Verpackungsplotter' },
                        'Produktion.html': { icon: 'bi-gear-wide-connected', text: 'Produktionsaufträge' },
                        'Zuschnitte.html': { icon: 'bi-crop', text: 'Zuschnitte' },
                        'Palettenkonto.html': { icon: 'bi-stack', text: 'Palettenkonto' },
                        'Aufgabe.html': { icon: 'bi-list-task', text: 'Aufgaben' },
                        'Entfernung.html': { icon: 'bi-geo-alt', text: 'Entfernung' },
                        'G-Code.html': { icon: 'bi-code-slash', text: 'G-Code Generator' },
                        'unternehmensplaner.html': { icon: 'bi-building', text: 'Unternehmensplanung' },
                        'Lieferant.html': { icon: 'bi-truck', text: 'Lieferanten' },
                        'Tourenplaner.html': { icon: 'bi-map', text: 'Tourenplaner' }
                    };

                    const sidebarMenu = document.querySelector('.sidebar-menu');
                    
                    // Lösche bestehende Menüpunkte außer "Startseite"
                    while (sidebarMenu.children.length > 1) {
                        sidebarMenu.removeChild(sidebarMenu.lastChild);
                    }

                    // Füge nur berechtigte Menüpunkte hinzu
                    Object.entries(menuItems).forEach(([page, details]) => {
                        if (userData.role === 'admin' || (userData.rights && userData.rights.includes(page))) {
                            const link = document.createElement('a');
                            link.href = page;
                            link.className = 'sidebar-item' + (page === 'Kalkulation.html' ? ' active' : '');
                            link.innerHTML = `
                                <i class="bi ${details.icon}"></i>
                                ${details.text}
                            `;
                            sidebarMenu.appendChild(link);
                        }
                    });
                });
            </script>
        </div>
    </div>

    <div class="main-content expanded" id="mainContent">
        <div id="root"></div>
    </div>

    <div class="version" style="position:fixed; bottom:10px; right:10px; font-size:12px; color:#718096; background:rgba(255,255,255,0.8); padding:4px 8px; border-radius:4px; box-shadow:0 1px 3px rgba(0,0,0,0.1); z-index:999;">Version 1.5.1</div>
    
    <!-- Hilfe-Modal -->
    <div class="modal fade" id="hilfeModal" tabindex="-1" aria-labelledby="hilfeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="hilfeModalLabel"><i class="bi bi-question-circle me-2"></i>Hilfe zur Kalkulation</h5>
                    <button type="button" class="btn-close" onclick="toggleHilfeDialog()" aria-label="Schließen"></button>
                </div>
                <div class="modal-body">
                    <h4>Benutzeranleitung zur Kalkulation</h4>
                    <p>Dieses Tool unterstützt Sie bei der präzisen Kalkulation von Preisen und Kosten.</p>
                    
                    <div class="accordion" id="hilfeAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button" type="button" onclick="toggleAccordion('collapseOne')">
                                    Grundlagen der Kalkulation
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#hilfeAccordion">
                                <div class="accordion-body">
                                    <p>Für eine erfolgreiche Kalkulation benötigen Sie folgende Grunddaten:</p>
                                    <ul>
                                        <li><strong>EK je Preiseinheit:</strong> Der Einkaufspreis pro Preiseinheit (ohne Fracht/Lagerkosten)</li>
                                        <li><strong>Preiseinheit:</strong> Die Einheit auf die sich der EK bezieht (1, 100 oder 1.000 Stück)</li>
                                        <li><strong>Aufschlag %:</strong> Prozentualer Aufschlag auf den EK je PE zur Berechnung des VK je PE</li>
                                        <li><strong>Menge:</strong> Die zu kalkulierende Menge in Stück</li>
                                        <li><strong>Paletten:</strong> Anzahl der benötigten Paletten für den Transport</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTwo">
                                <button class="accordion-button collapsed" type="button" onclick="toggleAccordion('collapseTwo')">
                                    Frachtkosten berechnen
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#hilfeAccordion">
                                <div class="accordion-body">
                                    <p><strong style="color: #b91c1c;">Wichtig:</strong> Frachtkosten erst berechnen, nachdem alle Artikel zur Sendung hinzugefügt wurden!</p>
                                    <p>Die Frachtkosten werden anteilig auf alle Artikel in der Sendung verteilt. Gehen Sie wie folgt vor:</p>
                                    <ol>
                                        <li>Fügen Sie zuerst alle Artikel zur Sendung hinzu</li>
                                        <li>Wählen Sie die Versandart und geben Sie die erforderlichen Daten ein</li>
                                        <li>Klicken Sie auf "Fracht berechnen", um die Frachtkosten zu ermitteln</li>
                                    </ol>
                                    <p>Die berechneten Frachtkosten werden automatisch anteilig auf die Artikel verteilt.</p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingThree">
                                <button class="accordion-button collapsed" type="button" onclick="toggleAccordion('collapseThree')">
                                    Arbeiten mit der Artikeltabelle
                                </button>
                            </h2>
                            <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#hilfeAccordion">
                                <div class="accordion-body">
                                    <p>In der Tabelle können Sie:</p>
                                    <ul>
                                        <li>Die Menge nachträglich anpassen</li>
                                        <li>Den VK je PE manuell eingeben (durch Klick auf den Wert)</li>
                                        <li>Artikel aus der Sendung entfernen</li>
                                        <li>Artikelpositionen nach verschiedenen Spalten sortieren</li>
                                    </ul>
                                    <p><strong>Tipp:</strong> Nach manueller Änderung des VK je PE wird der Aufschlag % automatisch neu berechnet.</p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFour">
                                <button class="accordion-button collapsed" type="button" onclick="toggleAccordion('collapseFour')">
                                    Speichern und PDF-Erstellung
                                </button>
                            </h2>
                            <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#hilfeAccordion">
                                <div class="accordion-body">
                                    <p><strong>Kalkulation speichern:</strong></p>
                                    <ol>
                                        <li>Klicken Sie auf "Speichern"</li>
                                        <li>Geben Sie die relevanten Informationen ein (Kunde, Beschreibung, etc.)</li>
                                        <li>Bestätigen Sie mit "Speichern"</li>
                                    </ol>
                                    <p><strong>PDF erstellen:</strong></p>
                                    <ol>
                                        <li>Klicken Sie auf "PDF erstellen"</li>
                                        <li>Das PDF wird automatisch generiert und zum Download angeboten</li>
                                        <li>Sie können das PDF speichern oder direkt ausdrucken</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="toggleHilfeDialog()">Schließen</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Dashboard-Modal -->
    <div class="modal fade" id="dashboardModal" tabindex="-1" aria-labelledby="dashboardModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="dashboardModalLabel">Business Intelligence Dashboard</h5>
                    <button type="button" class="btn-close btn-close-white" onclick="toggleDashboard()"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="dashboardTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">Übersicht</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends" type="button">Trends</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="customer-tab" data-bs-toggle="tab" data-bs-target="#customer" type="button">Kundenanalyse</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button">Produktanalyse</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="dashboardTabContent">
                        <!-- Übersicht Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <div class="row g-4">
                                <!-- KPI Cards -->
                                <div class="col-md-3">
                                    <div class="card border-primary h-100">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2 text-muted">Gesamtkalkulationen</h6>
                                            <h2 class="card-title" id="totalCalculations">0</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-success h-100">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2 text-muted">Gesamtumsatz</h6>
                                            <h2 class="card-title" id="totalRevenue">0,00 €</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-info h-100">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2 text-muted">Durchschnittliche Marge</h6>
                                            <h2 class="card-title" id="averageMargin">0,0%</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-warning h-100">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2 text-muted">Aktive Kunden</h6>
                                            <h2 class="card-title" id="uniqueCustomers">0</h2>
                                        </div>
                                    </div>
                                </div>

                                <!-- Grafiken -->
                                <div class="col-md-8">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title">Umsatzentwicklung</h5>
                                            <canvas id="revenueChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title">Top 5 Kunden</h5>
                                            <div class="list-group" id="topCustomers"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Trends Tab -->
                        <div class="tab-pane fade" id="trends" role="tabpanel">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title">Monatliche Verkäufe</h5>
                                            <div style="height: 400px;">
                                                <canvas id="monthlySalesChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title">Margenentwicklung</h5>
                                            <div style="height: 400px;">
                                                <canvas id="marginTrendChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Kundenanalyse Tab -->
                        <div class="tab-pane fade" id="customer" role="tabpanel">
                            <div class="row g-4">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">Kundenübersicht</h5>
                                            <div class="table-responsive">
                                                <table class="table table-striped" id="customerTable">
                                                    <thead>
                                                        <tr>
                                                            <th>Kunde</th>
                                                            <th>Anzahl Kalkulationen</th>
                                                            <th>Gesamtumsatz</th>
                                                            <th>Durchschnittliche Marge</th>
                                                            <th>Letzte Kalkulation</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="customerTableBody"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Produktanalyse Tab -->
                        <div class="tab-pane fade" id="products" role="tabpanel">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title">Top Produkte nach Umsatz</h5>
                                            <canvas id="topProductsChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title">Produktkategorien</h5>
                                            <canvas id="productCategoriesChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/babel" data-presets="react">
    const API_BASE = "http://192.168.1.20:5050";
    const API_URL = 'http://192.168.1.20:5050/api/kalkulationen'; // ggf. IP anpassen!
    let kalkulationen = [];
    let sortField = null;
    let sortDir = 1;
    
    // Optimierte Initialisierung mit Ladeindikator
    document.addEventListener('DOMContentLoaded', function() {
        const rootElement = document.getElementById("root");
        rootElement.innerHTML = '<div class="loading"><div style="text-align:center;"><div class="spinner-border text-primary" role="status"></div><p style="margin-top:10px;">Lade Anwendung...</p></div></div>';
    });
    
    
    async function fetchKalkulationenFromServer() {
      const res = await fetch(API_URL);
      kalkulationen = await res.json();
    }

    async function addKalkulationToServer(kalkulation) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(kalkulation)
      });
      return await res.json();
    }

    async function updateKalkulationOnServer(id, kalkulation) {
      await fetch(`${API_URL}/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(kalkulation)
      });
    }

    async function deleteKalkulationOnServer(id) {
      await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
    }

    async function renderKalkulationen() {
      await fetchKalkulationenFromServer();
      // Hier folgt die Logik zum Rendern der Kalkulationen analog zu renderTasks in Aufgabe.html
      // ...
    }

    async function addKalkulation() {
      // Sammle die Felder für eine neue Kalkulation (analog zu addTask)
      // ...
      await addKalkulationToServer({ /* Felder */ });
      renderKalkulationen();
    }

    async function updateKalkulationField(id, field, value) {
      const kalk = kalkulationen.find(k => k.id === id);
      if (!kalk) return;
      kalk[field] = value;
      await updateKalkulationOnServer(id, kalk);
      renderKalkulationen();
    }

    async function deleteKalkulation(id) {
      if (confirm("Möchtest du diese Kalkulation wirklich löschen?")) {
        await deleteKalkulationOnServer(id);
        renderKalkulationen();
      }
    }

    function sortKalkulationen(field) {
      if (sortField === field) {
        sortDir = -sortDir;
      } else {
        sortField = field;
        sortDir = 1;
      }
      renderKalkulationen();
    }

    window.addEventListener('DOMContentLoaded', renderKalkulationen);

        // Hilfsfunktion für deutsche Zahlenformatierung
        function formatDE(num) {
            return Number(num).toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // Hilfsfunktion für deutsche Zahlenformatierung mit einer Nachkommastelle
        function formatDE1(num) {
            return Number(num).toLocaleString("de-DE", { minimumFractionDigits: 1, maximumFractionDigits: 1 });
        }

        // Stückgutpreise nach PLZ-Range und Palettenanzahl (1-6 Paletten)
        const stueckgutPreistabelle = [
            { von: 1000, bis: 1999, preise: [75.42, 133.30, 163.28, 191.23, 249.47, 309.36] },
            { von: 2000, bis: 2999, preise: [75.42, 133.30, 163.28, 191.23, 249.47, 309.36] },
            { von: 3000, bis: 3999, preise: [72.92, 127.99, 156.98, 183.92, 239.53, 294.57] },
            { von: 4000, bis: 4999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 5000, bis: 5999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 6000, bis: 6999, preise: [72.66, 127.99, 156.98, 183.92, 239.53, 294.57] },
            { von: 7000, bis: 7999, preise: [72.66, 127.99, 156.98, 183.92, 239.53, 294.57] },
            { von: 8000, bis: 8999, preise: [72.66, 127.99, 156.98, 183.92, 239.53, 294.57] },
            { von: 9000, bis: 9999, preise: [72.92, 127.99, 156.98, 183.92, 239.53, 294.57] },
            { von: 10000, bis: 10999, preise: [75.42, 133.30, 163.28, 191.23, 249.47, 309.36] },
            { von: 11000, bis: 11999, preise: [75.42, 133.30, 163.28, 191.23, 249.47, 309.36] },
            { von: 12000, bis: 12999, preise: [75.42, 133.30, 163.28, 191.23, 249.47, 309.36] },
            { von: 13000, bis: 15999, preise: [75.42, 133.30, 163.28, 191.23, 249.47, 309.36] },
            { von: 16000, bis: 16999, preise: [78.07, 138.33, 169.36, 198.63, 262.03, 326.28] },
            { von: 17000, bis: 17999, preise: [78.07, 138.33, 169.36, 198.63, 262.03, 326.28] },
            { von: 18000, bis: 18999, preise: [75.42, 133.30, 163.28, 191.23, 249.47, 309.36] },
            { von: 19000, bis: 19999, preise: [75.42, 133.30, 163.28, 191.23, 249.47, 309.36] },
            { von: 20000, bis: 20999, preise: [75.42, 133.30, 163.28, 191.23, 249.47, 309.36] },
            { von: 21000, bis: 21999, preise: [75.42, 133.30, 163.28, 191.23, 249.47, 309.36] },
            { von: 22000, bis: 22999, preise: [75.42, 133.30, 163.28, 191.23, 249.47, 309.36] },
            { von: 23000, bis: 23999, preise: [78.07, 138.33, 169.36, 198.63, 262.03, 326.28] },
            { von: 24000, bis: 24999, preise: [78.07, 138.33, 169.36, 198.63, 262.03, 326.28] },
            { von: 25000, bis: 25999, preise: [75.42, 133.30, 163.28, 191.23, 249.47, 309.36] },
            { von: 26000, bis: 26999, preise: [75.42, 133.30, 163.28, 191.23, 249.47, 309.36] },
            { von: 27000, bis: 27999, preise: [75.42, 133.30, 163.28, 191.23, 249.47, 309.36] },
            { von: 28000, bis: 28999, preise: [75.42, 133.30, 163.28, 191.23, 249.47, 309.36] },
            { von: 29000, bis: 29999, preise: [75.42, 133.30, 163.28, 191.23, 249.47, 309.36] },
            { von: 30000, bis: 30999, preise: [72.92, 127.99, 156.98, 183.92, 239.53, 294.57] },
            { von: 31000, bis: 31999, preise: [72.92, 127.99, 156.98, 183.92, 239.53, 294.57] },
            { von: 32000, bis: 32999, preise: [72.92, 127.99, 156.98, 183.92, 239.53, 294.57] },
            { von: 33000, bis: 33999, preise: [72.92, 127.99, 156.98, 183.92, 239.53, 294.57] },
            { von: 34000, bis: 34999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 35000, bis: 35999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 36000, bis: 36999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 37000, bis: 37999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 38000, bis: 38999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 39000, bis: 39999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 40000, bis: 40999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 41000, bis: 41999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 42000, bis: 42999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 43000, bis: 43999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 44000, bis: 44999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 45000, bis: 45999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 46000, bis: 46999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 47000, bis: 47999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 48000, bis: 48999, preise: [72.66, 127.99, 156.98, 183.92, 239.53, 294.57] },
            { von: 49000, bis: 49999, preise: [72.66, 127.99, 156.98, 183.92, 239.53, 294.57] },
            { von: 50000, bis: 50999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 51000, bis: 51999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 52000, bis: 52999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 53000, bis: 53999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 54000, bis: 54999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 55000, bis: 55999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 56000, bis: 56999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 57000, bis: 57999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 58000, bis: 58999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 59000, bis: 59999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 60000, bis: 60999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 61000, bis: 61999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 62000, bis: 62999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 63000, bis: 63999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 64000, bis: 64999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 65000, bis: 65999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 66000, bis: 66999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 67000, bis: 67999, preise: [39.82, 66.48, 64.15, 76.53, 102.10, 127.88] },
            { von: 68000, bis: 68999, preise: [39.82, 66.48, 64.15, 76.53, 102.10, 127.88] },
            { von: 69000, bis: 69999, preise: [39.82, 66.48, 64.15, 76.53, 102.10, 127.88] },
            { von: 70000, bis: 70999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 71000, bis: 71999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 72000, bis: 72999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 73000, bis: 73999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 74000, bis: 74999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 75000, bis: 75999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 76000, bis: 76999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 77000, bis: 77999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 78000, bis: 78999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 79000, bis: 79999, preise: [51.99, 87.48, 106.44, 125.07, 175.04, 202.68] },
            { von: 80000, bis: 80999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 81000, bis: 81999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 82000, bis: 82999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 83000, bis: 83999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 84000, bis: 84999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 85000, bis: 85999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 86000, bis: 86999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 87000, bis: 87999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 88000, bis: 88999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 89000, bis: 89999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 90000, bis: 90999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 91000, bis: 91999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 92000, bis: 92999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 93000, bis: 93999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 94000, bis: 94999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 95000, bis: 95999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 96000, bis: 96999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] },
            { von: 97000, bis: 97999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 98000, bis: 98999, preise: [65.92, 115.46, 140.66, 165.26, 217.18, 265.36] },
            { von: 99000, bis: 99999, preise: [68.71, 120.72, 147.74, 173.05, 223.12, 278.82] }
        ];

        // Neue Stückgut-Preisfunktion
        function getStueckgutPreis(plz, paletten) {
            const plzNum = parseInt((plz || '').toString().replace(/\D/g, ''));
            let pal = Math.max(1, Math.min(6, parseInt(paletten) || 1));
            const eintrag = stueckgutPreistabelle.find(e => plzNum >= e.von && plzNum <= e.bis);
            if (eintrag) {
                const basis = eintrag.preise[pal-1];
                const preiserhoehung = basis * 0.0559;
                const basisMitPreiserhoehung = basis + preiserhoehung;
                const dieselzuschlag = basisMitPreiserhoehung * 0.1526;
                const palettentausch = pal * 3.80;
                const versicherung = 2.90;
                return {
                    basis: basis,
                    maut: 0,
                    palettentausch: palettentausch,
                    dieselzuschlag: dieselzuschlag,
                    versicherung: versicherung,
                    preiserhoehung: preiserhoehung,
                    paletten: pal
                };
            }
            // Fallback
            const basis = 100;
            const preiserhoehung = basis * 0.0559;
            const basisMitPreiserhoehung = basis + preiserhoehung;
            const dieselzuschlag = basisMitPreiserhoehung * 0.1526;
            const palettentausch = pal * 3.80;
            const versicherung = 2.90;
            return {
                basis: basis,
                maut: 0,
                palettentausch: palettentausch,
                dieselzuschlag: dieselzuschlag,
                versicherung: versicherung,
                preiserhoehung: preiserhoehung,
                paletten: pal
            };
        }

        function getUrlParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        const API_KEY_ORS = '5b3ce3597851110001cf624806251644e2ff42d1b8b71f4f95afc7e7';
        const FIRMENADRESSE = 'Robert-Bosch-Straße 1, 68542 Heddesheim';

        async function geocodeAdresse(adresse) {
            const url = `https://api.openrouteservice.org/geocode/search?api_key=${API_KEY_ORS}&text=${encodeURIComponent(adresse)}`;
            const res = await fetch(url);
            const data = await res.json();
            if (data.features && data.features.length > 0) {
                return data.features[0].geometry.coordinates; // [lng, lat]
            } else {
                throw new Error('Adresse nicht gefunden: ' + adresse);
            }
        }

        function App() {
            // States
            const [interneNummer, setInterneNummer] = React.useState("");
            const [kundenname, setKundenname] = React.useState("");
            const [ek, setEk] = React.useState("");
            const [preiseinheit, setPreiseinheit] = React.useState("1000");
            const [menge, setMenge] = React.useState("");
            const [stueckProPalette, setStueckProPalette] = React.useState("");
            const [aufschlag, setAufschlag] = React.useState("");
            const [versandart, setVersandart] = React.useState("lkw");
            const [strecke, setStrecke] = React.useState("");
            const [spedition, setSpedition] = React.useState("");
            const [plz, setPlz] = React.useState("");
            const [lieferantenSkonto, setLieferantenSkonto] = React.useState("2");
            const [skonto, setSkonto] = React.useState("2");
            const [artikelListe, setArtikelListe] = React.useState([]);
            const [gesamtMenge, setGesamtMenge] = React.useState(0);
            const [sendungsVersandkosten, setSendungsVersandkosten] = React.useState(0);
            const [vergleiche, setVergleiche] = React.useState([]);
            const [versandAktiv, setVersandAktiv] = React.useState(false);
            const [lagerPaletten, setLagerPaletten] = React.useState("");
            const [lagerDauer, setLagerDauer] = React.useState("");
            const [lagerGebuehr, setLagerGebuehr] = React.useState(5.5);
            const [dummyState, setDummyState] = React.useState(0);
            const [savedCalculations, setSavedCalculations] = React.useState([]);
            const [searchQuery, setSearchQuery] = React.useState("");
            const [showDatabase, setShowDatabase] = React.useState(false);
            const [adresseFeld, setAdresseFeld] = React.useState("");
            const [entfernungStatus, setEntfernungStatus] = React.useState("");
            const [activeTab, setActiveTab] = React.useState("kalkulation"); // Neuer State für das aktuelle Tab
            const [behalteKundendaten, setBehalteKundendaten] = React.useState(false); // State für die Checkbox zum Beibehalten der Kundendaten
            const [volleFrachtJePosition, setVolleFrachtJePosition] = React.useState(false); // Neuer State für die Checkbox zur Frachtberechnung

            React.useEffect(() => {
                const ekParam = getUrlParam('ek');
                const einheitParam = getUrlParam('einheit');
                const mengeParam = getUrlParam('menge');
                const stkPaletteParam = getUrlParam('stkPalette');
                if (ekParam) setEk(ekParam);
                if (einheitParam) setPreiseinheit(einheitParam);
                if (mengeParam) setMenge(mengeParam);
                if (stkPaletteParam) setStueckProPalette(stkPaletteParam);
            }, []);

            // Versand aktivieren, sobald mindestens ein Artikel in der Sendung ist
            React.useEffect(() => {
                setVersandAktiv(artikelListe.length > 0);
            }, [artikelListe]);

            // Frachtkostenberechnung in Echtzeit
            const berechneFrachtkosten = React.useCallback(() => {
                const mengeNum = parseFloat(menge) || 0;
                const stueckProPaletteNum = parseFloat(stueckProPalette) || 0;
                // Für alle Versandarten: immer die gesamte Palettenanzahl aus der Sendung nehmen
                let anzahlPaletten = 1;
                if (artikelListe.length > 0) {
                    anzahlPaletten = artikelListe.reduce((sum, a) => sum + (a.anzahlPaletten || 0), 0);
                } else if (mengeNum > 0 && stueckProPaletteNum > 0) {
                    anzahlPaletten = Math.ceil(mengeNum / stueckProPaletteNum);
                }

                let versandkosten = 0;
                let basisKosten = 0;
                let mautKosten = 0;
                let palettentausch = 0;
                let dieselzuschlag = 0;
                let versicherung = 0;
                let preiserhoehung = 0;
                let stueckgutHinweis = "";

                if (versandart === "lkw") {
                    versandkosten = (parseFloat(strecke) || 0) * 2 * 1.35;
                    if (anzahlPaletten > 15) {
                        stueckgutHinweis = "Achtung: LKW kann maximal 15 Paletten transportieren!";
                    }
                } else if (versandart === "lkwZug") {
                    versandkosten = (parseFloat(strecke) || 0) * 2 * 1.6;
                    if (anzahlPaletten > 33) {
                        stueckgutHinweis = "Achtung: LKW Zug kann maximal 33 Paletten transportieren!";
                    }
                } else if (versandart === "bus") {
                    versandkosten = (parseFloat(strecke) || 0) * 2 * 0.8;
                } else if (versandart === "spedition") {
                    versandkosten = parseFloat(spedition) || 0;
                } else if (versandart === "stueckgut") {
                    if (anzahlPaletten > 6) {
                        stueckgutHinweis = "Maximal 6 Paletten pro Sendung bei Stückgut! Es werden nur 6 Paletten berechnet.";
                        anzahlPaletten = 6;
                    }
                    const stueckgutPreis = getStueckgutPreis(plz, anzahlPaletten);
                    basisKosten = stueckgutPreis.basis;
                    preiserhoehung = stueckgutPreis.preiserhoehung;
                    palettentausch = stueckgutPreis.palettentausch;
                    dieselzuschlag = stueckgutPreis.dieselzuschlag;
                    versicherung = stueckgutPreis.versicherung;
                    const basisMitPreiserhoehung = basisKosten + preiserhoehung;
                    mautKosten = +(basisKosten * 0.0794).toFixed(2); // 7,94% des Basispreises
                    versandkosten = basisMitPreiserhoehung + palettentausch + dieselzuschlag + versicherung + mautKosten;
                }

                return {
                    gesamt: versandkosten,
                    basis: basisKosten,
                    maut: mautKosten,
                    palettentausch: palettentausch,
                    dieselzuschlag: dieselzuschlag,
                    versicherung: versicherung,
                    preiserhoehung: preiserhoehung,
                    paletten: anzahlPaletten,
                    stueckgutHinweis: stueckgutHinweis
                };
            }, [versandart, strecke, spedition, plz, menge, stueckProPalette, artikelListe]);

            const frachtkosten = berechneFrachtkosten();

            // Einzelartikel-Kalkulation in Echtzeit
            const berechneErgebnis = React.useCallback(() => {
                const ekNum = parseFloat(ek) || 0;
                const einheit = parseFloat(preiseinheit) || 1;
                const aufschlagNum = parseFloat(aufschlag) || 0;
                // vkWunsch Referenz entfernt
                const mengeNum = parseFloat(menge) || 0;
                const stueckProPaletteNum = parseFloat(stueckProPalette) || 0;
                
                // Anzahl der Preiseinheiten berechnen, was für die Lagerkosten-Berechnung wichtig ist
                const anzahlPreiseinheiten = mengeNum > 0 ? mengeNum / einheit : 0;
                


                let anzahlPaletten = 0;
                if (mengeNum > 0 && stueckProPaletteNum > 0) {
                    anzahlPaletten = Math.ceil(mengeNum / stueckProPaletteNum);
                }

                // Versandkosten für Einzelartikel
                let versandkosten = frachtkosten.gesamt;

                // VK/Endpreis je Preiseinheit
                let vkJePreiseinheit = 0;
                let vkInklVersandJePreiseinheit = 0;
                
                // VK aus EK und Aufschlag berechnen
                // Immer berechnen, auch wenn aufschlagNum 0 ist
                vkJePreiseinheit = ekNum * (1 + aufschlagNum / 100);
                vkInklVersandJePreiseinheit = vkJePreiseinheit + (mengeNum > 0 ? versandkosten * (einheit / mengeNum) : 0);

                // Aufschlag in %
                let aufschlagProzent = ekNum > 0 ? ((vkInklVersandJePreiseinheit - ekNum) / ekNum) * 100 : 0;

                // Gesamter EK und VK
                const gesamtEK = ekNum * (mengeNum / einheit);
                const gesamtVK = vkJePreiseinheit * (mengeNum / einheit);

                // Deckungsbeitrag je Preiseinheit und gesamt
                const dbJePreiseinheit = vkJePreiseinheit - ekNum;
                const dbGesamt = dbJePreiseinheit * anzahlPreiseinheiten;

                return {
                    ekJePreiseinheit: ekNum,
                    versandkosten,
                    vkJePreiseinheit,
                    vkInklVersandJePreiseinheit,
                    dbJePreiseinheit,
                    dbGesamt,
                    anzahlPaletten,
                    mengeNum,
                    einheit,
                    aufschlagProzent,
                    gesamtEK,
                    gesamtVK
                };
            }, [ek, preiseinheit, aufschlag, menge, stueckProPalette, frachtkosten.gesamt]);

            const aktuellesErgebnis = berechneErgebnis();

            // Lagerkosten-Berechnung
            const berechneLagerkosten = React.useCallback(() => {
                const paletten = parseFloat(lagerPaletten) || aktuellesErgebnis.anzahlPaletten || 0;
                const monate = parseInt(lagerDauer) || 0;
                const gebuehr = lagerGebuehr;
                
                if (paletten === 0 || monate === 0 || gebuehr === 0) return { gesamt: 0, proEinheit: 0 };
                
                // Berechnung: Im ersten Monat werden alle Paletten gelagert.
                // In den folgenden Monaten erfolgt eine gleichmäßige Entnahme.
                let summe = 0;
                
                if (monate <= 1) {
                    // Bei nur einem Monat: alle Paletten * Gebühr
                    summe = paletten * gebuehr;
                } else {
                    // Im ersten Monat werden alle Paletten gelagert
                    summe = paletten * gebuehr;
                    
                    // Berechne die gleichmäßige Entnahme pro Monat (nach dem ersten Monat)
                    // z.B. bei 12 Paletten und 4 Monaten: 12/(4-1) = 4 Paletten pro Monat nach dem ersten
                    const abbauProMonat = paletten / (monate - 1);
                    
                    // Für die restlichen Monate die Lagerkosten berechnen
                    for (let m = 1; m < monate; m++) {
                        // Anzahl der noch zu lagernden Paletten in diesem Monat
                        const verbleibendePaletten = Math.max(0, paletten - (m * abbauProMonat));
                        summe += verbleibendePaletten * gebuehr;
                    }
                }
                
                // Auf VK gesamt verteilen (auf alle Preiseinheiten)
                const einheit = aktuellesErgebnis.einheit || 1;
                const menge = aktuellesErgebnis.mengeNum || 0;
                
                // Lagerkosten pro Preiseinheit berechnen
                // Anzahl der Preiseinheiten korrekt berechnen: menge / einheit
                // Bei 1000 Stück und PE=1000 → 1 Preiseinheit
                // Bei 1000 Stück und PE=500 → 2 Preiseinheiten (1000/500 = 2)
                
                // Verwende die bereits berechnete anzahlPreiseinheiten, falls vorhanden
                let anzahlPreiseinheiten = 0;
                if (menge > 0) {
                    if (aktuellesErgebnis.anzahlPreiseinheiten) {
                        // Verwende den bereits berechneten Wert
                        anzahlPreiseinheiten = aktuellesErgebnis.anzahlPreiseinheiten;
                    } else {
                        // Berechne neu
                        anzahlPreiseinheiten = menge / einheit;
                    }
                }
                
                // Berechnung der Lagerkosten pro Preiseinheit
                const proEinheit = anzahlPreiseinheiten > 0 ? summe / anzahlPreiseinheiten : 0;
                


                
                return { 
                    gesamt: summe, 
                    proEinheit,
                    // Zusätzliche Informationen zur Diagnose
                    paletten: paletten,
                    monate: monate, 
                    gebuehr: gebuehr,
                    anzahlPreiseinheiten: anzahlPreiseinheiten
                };
            }, [lagerDauer, lagerPaletten, lagerGebuehr, aktuellesErgebnis]);
            const lagerkosten = berechneLagerkosten();

            function resetForm() {
                setInterneNummer("");
                setKundenname("");
                setEk("");
                setPreiseinheit("1000");
                setMenge("");
                setStueckProPalette("");
                setAufschlag("");
                // setVkWunsch(""); // Entfernt da VK Wunschpreis nicht mehr verwendet wird
                setVersandart("lkw");
                setStrecke("");
                setSpedition("");
                setPlz("");
                setLieferantenSkonto("2");
                setSkonto("2");
                setArtikelListe([]); // Artikelliste leeren
                setGesamtMenge(0);
                setSendungsVersandkosten(0); // Versandkosten zurücksetzen
                setVergleiche([]);
                setVersandAktiv(false);
                setLagerPaletten("");
                setLagerDauer("");
                setLagerGebuehr(5.5); // Lagergebühr auf Standardwert zurücksetzen
                setAdresseFeld(""); // Firmenname/Kundenadresse leeren
                setEntfernungStatus(""); // Entfernungsergebnis leeren
                setBehalteKundendaten(false); // Checkbox "Angebotsnummer und Kundenname beibehalten" deaktivieren
                setVolleFrachtJePosition(false); // Checkbox für nicht-anteilige Frachtberechnung deaktivieren
                setDummyState(s => s + 1); // Re-Render erzwingen
            }

            // Artikel zur Sendung hinzufügen
            function artikelZurSendungHinzufuegen() {
                if (aktuellesErgebnis) {
                    // Lagerkostenanteil berechnen
                    const lagerkostenProEinheit = lagerkosten.proEinheit || 0;
                    // Paletten aus der manuellen Eingabe oder aus der automatischen Berechnung
                    const anzahlPaletten = parseFloat(lagerPaletten) || aktuellesErgebnis.anzahlPaletten || 0;
                    
                    // Basis-EK ohne Lagerkosten
                    const ekOhneLager = parseFloat(ek) || 0;
                    
                    // EK mit Lagerkosten
                    const ekMitLager = ekOhneLager + lagerkostenProEinheit;
                    
                    // Aufschlag auf EK mit Lagerkosten anwenden
                    const aufschlagNum = parseFloat(aufschlag) || 0;
                    const vkMitLager = ekMitLager * (1 + aufschlagNum / 100);
                    
                    // Menge und Preiseinheit für Berechnungen
                    const mengeNum = parseFloat(menge) || 0;
                    const einheit = parseFloat(preiseinheit) || 1;
                    const anzahlPreiseinheiten = mengeNum / einheit;
                    
                    // Gesamtsummen korrekt berechnen
                    const gesamtEK = ekMitLager * anzahlPreiseinheiten;
                    const gesamtVK = vkMitLager * anzahlPreiseinheiten;
                    
                    const artikel = {
                        ...aktuellesErgebnis,
                        interneNummer,
                        kundenname,
                        menge: mengeNum,
                        mengeNum: mengeNum, // Sicherstellen, dass beide Felder korrekt gesetzt werden
                        einheit: einheit,
                        anzahlPreiseinheiten: anzahlPreiseinheiten,
                        lagerkostenProEinheit: lagerkostenProEinheit,
                        lagerPaletten: anzahlPaletten,
                        lagerMonate: parseInt(lagerDauer) || 0,
                        lagerGebuehrJePalette: parseFloat(lagerGebuehr) || 5.5,
                        stueckProPalette: parseFloat(stueckProPalette) || 0,
                        anteiligeFracht: 0, // Wird später bei artikelMitFracht berechnet
                        frachtProEinheit: 0, // Wird später berechnet
                        ekJePreiseinheit: ekOhneLager, // Basis-EK ohne Lager
                        ekJePreiseinheitMitFracht: ekMitLager, // EK mit Lager
                        vkJePreiseinheit: vkMitLager, // Hier den korrekten VK setzen
                        vkEndpreisMitFracht: vkMitLager, // VK basierend auf EK mit Lager
                        aufschlagProzent: aufschlagNum, // Aufschlag speichern
                        gesamtEK: gesamtEK, // Explizit die Gesamtsummen setzen
                        gesamtVK: gesamtVK,
                        // Explizit keinen exactUserVkValue setzen, damit die normale Berechnung greift
                        exactUserVkValue: undefined,
                        // Werte für die Frachtberechnung
                        originalAufschlag: aufschlagNum, // Ursprünglicher Aufschlag vor Frachtberechnung
                        // Hinzufügen der Edit-Status-Flags für alle editierbaren Felder
                        isEditingNummer: false,
                        isEditingVK: false
                    };
                    setArtikelListe(prev => [...prev, artikel]);
                    setGesamtMenge(prev => prev + mengeNum);
                    
                    // Kundendaten nur zurücksetzen, wenn die Checkbox nicht aktiviert ist
                    if (!behalteKundendaten) {
                        setInterneNummer("");
                        setKundenname("");
                    }
                    
                    // Andere Felder immer zurücksetzen
                    setEk("");
                    setMenge("");
                    setStueckProPalette("");
                    setAufschlag("");
                    setLagerDauer(""); // Lagerungsdauer in Monaten zurücksetzen
                    // setVkWunsch(""); // Entfernt da VK Wunschpreis nicht mehr verwendet wird
                    setErgebnis(null);
                    if (!versandAktiv) setVersandAktiv(true);
                }
            }

            // Versandkosten für die gesamte Sendung berechnen (aus aktuellem Formular)
            function berechneSendungsVersandkosten() {
                let versandkosten = 0;
                if (versandart === "lkw") {
                    versandkosten = (parseFloat(strecke) || 0) * 2 * 1.35;
                    // Prüfe auf maximale Palettenanzahl
                    let gesamtPaletten = artikelListe.reduce((sum, a) => sum + (a.anzahlPaletten || 0), 0);
                    if (gesamtPaletten > 15) {
                        alert("Achtung: LKW kann maximal 15 Paletten transportieren!");
                    }
                } else if (versandart === "lkwZug") {
                    versandkosten = (parseFloat(strecke) || 0) * 2 * 1.6;
                    // Prüfe auf maximale Palettenanzahl
                    let gesamtPaletten = artikelListe.reduce((sum, a) => sum + (a.anzahlPaletten || 0), 0);
                    if (gesamtPaletten > 33) {
                        alert("Achtung: LKW Zug kann maximal 33 Paletten transportieren!");
                    }
                } else if (versandart === "bus") {
                    versandkosten = (parseFloat(strecke) || 0) * 2 * 0.8;
                } else if (versandart === "spedition") {
                    versandkosten = parseFloat(spedition) || 0;
                } else if (versandart === "stueckgut") {
                    // Gesamtpalettenzahl aller Artikel berechnen (max. 6)
                    let gesamtPaletten = artikelListe.reduce((sum, a) => sum + (a.anzahlPaletten || 0), 0);
                    if (gesamtPaletten > 6) gesamtPaletten = 6;
                    const stueckgutPreis = getStueckgutPreis(plz, gesamtPaletten);
                    const basisMitPreiserhoehung = stueckgutPreis.basis + stueckgutPreis.preiserhoehung;
                    versandkosten = basisMitPreiserhoehung + stueckgutPreis.dieselzuschlag + stueckgutPreis.palettentausch + stueckgutPreis.versicherung;
                }
                setSendungsVersandkosten(versandkosten);
                
                // Spezielle Behandlung für Artikel mit 0% Aufschlag
                // Diese benötigen eine sofortige Aktualisierung des VK je PE
                const updateList = [...artikelListe].map(artikel => {
                    // Nur bei Artikeln mit Aufschlag 0% den VK aktualisieren
                    if (artikel.aufschlagProzent === 0) {
                        // Fracht neu berechnen
                        const mengeNum = artikel.mengeNum || 1;
                        const einheit = artikel.einheit || 1;
                        
                        // Anteilige Fracht berechnen
                        const gesamtPaletten = artikelListe.reduce((sum, a) => sum + (a.anzahlPaletten || 0), 0) || 1;
                        const anteil = gesamtPaletten > 0 ? ((artikel.anzahlPaletten || 0) / gesamtPaletten) : 0;
                        const anteiligeFracht = versandkosten * anteil;
                        
                        // Fracht pro Preiseinheit
                        const frachtProEinheit = anteiligeFracht / (mengeNum / einheit);
                        
                        // EK mit aktualisierter Fracht und Lagerkosten
                        const ekMitFrachtUndLager = (artikel.ekJePreiseinheit || 0) + frachtProEinheit + (artikel.lagerkostenProEinheit || 0);
                        
                        // Anzahl der Preiseinheiten
                        const anzahlPreiseinheiten = mengeNum / einheit;
                        
                        // Bei 0% Aufschlag ist VK = EK mit Fracht
                        // Gesamtbeträge berechnen
                        const gesamtEK = ekMitFrachtUndLager * anzahlPreiseinheiten;
                        
                        return {
                            ...artikel,
                            ekJePreiseinheitMitFracht: ekMitFrachtUndLager, // Aktualisiere auch den EK mit Fracht
                            vkJePreiseinheit: ekMitFrachtUndLager,
                            vkEndpreisMitFracht: ekMitFrachtUndLager,
                            exactUserVkValue: ekMitFrachtUndLager,
                            // DB ist bei 0% Aufschlag immer 0
                            dbJePreiseinheit: 0,
                            dbGesamt: 0,
                            // Gesamtbeträge aktualisieren
                            gesamtEK: gesamtEK,
                            gesamtVK: gesamtEK, // Bei 0% Aufschlag ist VK = EK
                            // Stelle sicher, dass der Aufschlag exakt 0 ist
                            aufschlagProzent: 0,
                            originalAufschlag: 0,
                            anteiligeFracht: anteiligeFracht,
                            frachtProEinheit: frachtProEinheit
                        };
                    }
                    
                    return artikel;
                });
                
                // Aktualisierte Artikelliste speichern
                if (updateList.some(art => art.aufschlagProzent === 0)) {
                    setArtikelListe(updateList);
                }
                
                // Nach Berechnung der Frachtkosten erzwinge Re-Render der Tabelle
                // und berechne alles neu
                setTimeout(() => {
                    // Verzögerung, um sicherzustellen, dass die Artikelliste aktualisiert wurde
                    setDummyState(s => s + 1);
                }, 50);
            }

            // Versandkosten-Anteil pro Artikel berechnen
            let summeAnteiligeFracht = 0;
            const gesamtPaletten = artikelListe.reduce((sum, a) => sum + (a.anzahlPaletten || 0), 0) || 1;
            const artikelMitFracht = artikelListe.map((artikel, idx) => {
                let anteiligeFracht = 0;
                // Für Stückgut: immer frachtkosten.gesamt als Basis nehmen
                const gesamtFracht = versandart === "stueckgut" ? frachtkosten.gesamt : sendungsVersandkosten;
                
                // Wenn die Checkbox "Fracht nicht anteilig aufteilen" aktiviert ist
                if (volleFrachtJePosition) {
                    // Jeder Position die vollen Frachtkosten zuweisen
                    anteiligeFracht = gesamtFracht;
                } else if (artikelListe.length === 1) {
                    // Nur ein Artikel in der Liste: volle Fracht
                    anteiligeFracht = gesamtFracht;
                } else {
                    // Anteilige Fracht basierend auf der Palettenanzahl
                    const anteil = gesamtPaletten > 0 ? ((artikel.anzahlPaletten || 0) / gesamtPaletten) : 0;
                    if (idx < artikelListe.length - 1) {
                        anteiligeFracht = Math.round((gesamtFracht * anteil) * 100) / 100;
                        summeAnteiligeFracht += anteiligeFracht;
                    } else {
                        anteiligeFracht = Math.round((gesamtFracht - summeAnteiligeFracht) * 100) / 100;
                    }
                }
                
                // Basiswerte abrufen
                const mengeNum = artikel.mengeNum || 1;
                const einheit = artikel.einheit || 1;
                
                // Berechne Fracht pro Preiseinheit
                const frachtProEinheit = anteiligeFracht / (mengeNum / einheit);
                
                // Berechne immer den korrekten EK mit Fracht und Lager
                // Ursprünglicher EK je PE
                const ekOhneFracht = artikel.ekJePreiseinheit || 0;
                // Lagerkosten pro Einheit
                const lagerKostenProEinheit = artikel.lagerkostenProEinheit || 0;
                // EK mit Fracht und Lager berechnen
                const ekMitFrachtUndLager = ekOhneFracht + frachtProEinheit + lagerKostenProEinheit;
                
                // Existierender Aufschlag oder Standardwert
                                                                                    const aufschlag = artikel.aufschlagProzent || 0;
                                                                    
                                                                    // Prüfen, ob der Benutzer einen neuen VK eingegeben hat oder ob wir den Aufschlag verwenden
                                                                    let vkJePreiseinheit = 0;
                                                                    let aktuellerAufschlag = aufschlag;
                                                                    
                                                                    // Wenn der Benutzer manuell einen VK eingegeben hat, hat dieser Vorrang
                                                                    if (artikel.exactUserVkValue !== undefined) {
                                                                        // Benutzer hat VK manuell gesetzt - diesen verwenden
                                                                        vkJePreiseinheit = artikel.exactUserVkValue;
                                                                        // Aufschlag neu berechnen
                                                                        aktuellerAufschlag = ((vkJePreiseinheit / ekMitFrachtUndLager) - 1) * 100;
                                                                    } else {
                                                                        // Berechne VK basierend auf EK mit Fracht und Aufschlag
                                                                        // Bei 0% Aufschlag wäre der VK gleich dem EK mit Fracht
                                                                        vkJePreiseinheit = ekMitFrachtUndLager * (1 + aufschlag / 100);
                                                                    }
                
                // WICHTIG: Immer den neuberechneten VK je PE verwenden
                const vkEndpreisMitFracht = vkJePreiseinheit;
                
                // Anzahl der Preiseinheiten berechnen
                const anzahlPreiseinheiten = mengeNum / einheit;
                
                // DB je PE auf Basis des EK mit Fracht und Lager
                const dbJePE = vkEndpreisMitFracht - ekMitFrachtUndLager;
                
                // Gesamtwerte berechnen
                const dbGesamt = dbJePE * anzahlPreiseinheiten;
                const gesamtEK = ekMitFrachtUndLager * anzahlPreiseinheiten;
                const gesamtVK = vkEndpreisMitFracht * anzahlPreiseinheiten;
                
                // Einkaufssumme setzen - muss den kompletten EK mit Fracht und Lager berücksichtigen
                const einkaufssumme = ekMitFrachtUndLager * anzahlPreiseinheiten;
                
                return {
                    ...artikel,
                    anteiligeFracht,
                    frachtProEinheit,
                    ekJePreiseinheitMitFracht: ekMitFrachtUndLager,
                    vkJePreiseinheit: vkEndpreisMitFracht, // Priorität für die Anzeige: vkEndpreisMitFracht verwenden
                    vkEndpreisMitFracht,
                    dbJePreiseinheit: dbJePE,
                    dbGesamt,
                    einkaufssumme, // Die korrigierte Einkaufssumme mit Fracht
                    gesamtEK,
                    gesamtVK,
                    anzahlPreiseinheiten,
                    // Bei 0% Aufschlag oder direkte Eingabe den exactUserVkValue entsprechend setzen
                    exactUserVkValue: aktuellerAufschlag === 0 ? ekMitFrachtUndLager : artikel.exactUserVkValue,
                    aufschlagProzent: aktuellerAufschlag // Aktualisierter Aufschlag basierend auf EK mit Fracht
                };
            });

            // Vergleichstabelle: Ergebnisse übertragen
            function ergebnisInVergleichUebernehmen() {
                if (aktuellesErgebnis) {
                    setVergleiche(prev => [...prev, {
                        ...aktuellesErgebnis,
                        interneNummer,
                        kundenname
                    }]);
                }
            }

            // PDF-Export-Funktion für Artikelliste
            function exportierePDF() {
                const element = document.getElementById("artikel-tabelle");
                if (!element) return;
                // Auch das table-Element und den Tabellen-Container anpassen
                const table = element.querySelector('table');
                const tableContainer = element.querySelector('div');
                // Alte Werte speichern
                const oldWidth = element.style.width;
                const oldOverflow = element.style.overflowX;
                const oldTableWidth = table ? table.style.width : '';
                const oldTableContainerWidth = tableContainer ? tableContainer.style.width : '';
                const oldTableContainerOverflow = tableContainer ? tableContainer.style.overflowX : '';
                const oldTableContainerMarginLeft = tableContainer ? tableContainer.style.marginLeft : '';
                const oldTableContainerMaxWidth = tableContainer ? tableContainer.style.maxWidth : '';
                // Speichere alte Werte der ersten Spalte
                let ths = [];
                let tds = [];
                let oldThWidths = [];
                let oldTdWidths = [];
                if (table) {
                  ths = Array.from(table.querySelectorAll('th:first-child'));
                  tds = Array.from(table.querySelectorAll('td:first-child'));
                  oldThWidths = ths.map(th => ({ width: th.style.width, minWidth: th.style.minWidth }));
                  oldTdWidths = tds.map(td => ({ width: td.style.width, minWidth: td.style.minWidth }));
                  ths.forEach(th => { th.style.width = '110px'; th.style.minWidth = '110px'; });
                  tds.forEach(td => { td.style.width = '110px'; td.style.minWidth = '110px'; });
                }
                // Auf volle Breite setzen
                element.style.width = 'auto';
                element.style.overflowX = 'visible';
                if (table) table.style.width = 'auto';
                if (tableContainer) {
                  tableContainer.style.width = '100%';
                  tableContainer.style.overflowX = 'visible';
                  tableContainer.style.marginLeft = '0';
                  tableContainer.style.maxWidth = 'none';
                }
                window.html2canvas(element, { scale: 2 }).then(canvas => {
                    // Nach Screenshot zurücksetzen
                    element.style.width = oldWidth;
                    element.style.overflowX = oldOverflow;
                    if (table) table.style.width = oldTableWidth;
                    if (tableContainer) {
                      tableContainer.style.width = oldTableContainerWidth;
                      tableContainer.style.overflowX = oldTableContainerOverflow;
                      tableContainer.style.marginLeft = oldTableContainerMarginLeft;
                      tableContainer.style.maxWidth = oldTableContainerMaxWidth;
                    }
                    // Setze Spaltenbreiten zurück
                    if (table) {
                      ths.forEach((th, i) => { th.style.width = oldThWidths[i].width; th.style.minWidth = oldThWidths[i].minWidth; });
                      tds.forEach((td, i) => { td.style.width = oldTdWidths[i].width; td.style.minWidth = oldTdWidths[i].minWidth; });
                    }
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new window.jspdf.jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    // Tabelle in Originalgröße (keine zusätzliche Verkleinerung)
                    const scaleFactor = 1;
                    const imgWidth = (pageWidth - 20) * scaleFactor;
                    const imgHeight = canvas.height * (imgWidth / canvas.width);
                    let y = 20;
                    let finalImgWidth = imgWidth;
                    let finalImgHeight = imgHeight;
                    if (imgHeight > pageHeight - 40) {
                        finalImgHeight = (pageHeight - 40) * scaleFactor;
                        finalImgWidth = canvas.width * (finalImgHeight / canvas.height);
                        y = (pageHeight - finalImgHeight) / 2;
                    }
                    pdf.addImage(imgData, 'PNG', (pageWidth - finalImgWidth) / 2, y, finalImgWidth, finalImgHeight);
                    pdf.save('artikel-in-der-sendung.pdf');
                });
            }

            // Hilfsfunktion für eindeutige ID
            function generateKalkulationId() {
                return Date.now().toString() + Math.floor(Math.random()*10000).toString();
            }

            // Speichern
            async function saveKalkulation() {
                // Eindeutige ID für die Kalkulation
                const kalkulation_id = generateKalkulationId();
                const datum = new Date().toISOString();
                const artikelListe = artikelMitFracht; // alle Artikel mit Fracht und Details
                
                // Einfacher direkt aus localStorage holen
                const loggedInUser = localStorage.getItem('loggedInUser') || 'unbekannt';
                const erstellerName = loggedInUser.charAt(0).toUpperCase() + loggedInUser.slice(1);


                
                // Teste den direkten Zugriff auf localStorage
                document.getElementById('userName').textContent = erstellerName;
                
                // Stelle sicher, dass artikelListe ein Array ist
                if (!Array.isArray(artikelListe)) {
                    console.error("artikelListe ist kein Array:", artikelListe);
                    alert("Fehler: Keine Artikel zum Speichern verfügbar!");
                    return;
                }
                
                try {
                    const payload = { 
                        kalkulation_id, 
                        datum, 
                        artikelListe,
                        ersteller: erstellerName // Benutzer als Ersteller hinzufügen mit korrekter Schreibweise
                    };
                    

                    
                    const response = await fetch('http://192.168.1.20:5050/api/kalkulationen', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();

                    
                    if (data.status === 'success') {
                        alert('Kalkulation erfolgreich gespeichert!');
                        await loadKalkulationen();
                        resetForm();
                    }
                } catch (error) {
                    console.error("Fehler beim Speichern:", error);
                    alert('Fehler beim Speichern!');
                }
            }

            // Laden
            async function loadKalkulationen() {
                try {
                    const response = await fetch('http://192.168.1.20:5050/api/kalkulationen');
                    const data = await response.json();
                    setSavedCalculations(data);
                } catch (error) {
                    alert('Fehler beim Laden!');
                }
            }

            // Suche
            const filteredCalculations = savedCalculations.filter(calc =>
                (!searchQuery ||
                    (calc.kunde && calc.kunde.toLowerCase().includes(searchQuery.toLowerCase())) ||
                    (calc.beschreibung && calc.beschreibung.toLowerCase().includes(searchQuery.toLowerCase())) ||
                    (calc.material && calc.material.toLowerCase().includes(searchQuery.toLowerCase()))
                )
            );

            // Beim ersten Rendern laden
            React.useEffect(() => { loadKalkulationen(); }, []);

            // Kompakte Datenbank-Übersichtstabelle (gruppiert, mit Checkboxen zum Löschen)
            function DatabaseTable() {
                const [selectedRows, setSelectedRows] = React.useState([]);
                const [deleteError, setDeleteError] = React.useState("");
                const [filterEsteller, setFilterErsteller] = React.useState("");
                const [filterKunde, setFilterKunde] = React.useState("");
                const [filterAngebotsnummer, setFilterAngebotsnummer] = React.useState("");
                const [sortField, setSortField] = React.useState(null);
                const [sortDirection, setSortDirection] = React.useState(1); // 1 = aufsteigend, -1 = absteigend
                
                // Alle Artikel aus allen Kalkulationen in einer Liste sammeln
                const allArtikel = savedCalculations.flatMap(kalk => {
                    // Ersteller-Information aus der Kalkulation für jeden Artikel übernehmen
                    if (kalk.artikel && Array.isArray(kalk.artikel)) {
                        return kalk.artikel.map(art => {
                            // Ersteller bleibt unverändert - "unbekannt" für alte Einträge
                            const ersteller = kalk.ersteller || 'unbekannt';
                            
                            return {
                                ...art,
                                ersteller: ersteller
                            };
                        });
                    }
                    return [];
                });
                
                // Gefilterte Artikelliste basierend auf den Filterkriterien
                const filteredArtikel = allArtikel.filter(art => {
                    const matchesErsteller = !filterEsteller || 
                        (art.ersteller && art.ersteller.toLowerCase().includes(filterEsteller.toLowerCase()));
                    const matchesKunde = !filterKunde || 
                        (art.kundenname && art.kundenname.toLowerCase().includes(filterKunde.toLowerCase()));
                    const matchesAngebotsnummer = !filterAngebotsnummer || 
                        (art.angebotsnummer && art.angebotsnummer.toLowerCase().includes(filterAngebotsnummer.toLowerCase()));
                    
                    return matchesErsteller && matchesKunde && matchesAngebotsnummer;
                });
                
                const handleCheckboxChange = React.useCallback((id, checked) => {
                    setSelectedRows(prev => {
                        if (checked) {
                            return [...prev, id];
                        } else {
                            return prev.filter(rowId => rowId !== id);
                        }
                    });
                }, []);

                const handleDeleteSelected = React.useCallback(async () => {
                    try {
                        if (selectedRows.length === 0) return;
                        if (!window.confirm('Ausgewählte Einträge wirklich löschen?')) return;
                        let errors = [];
                        for (const id of selectedRows) {
                            try {
                                const res = await fetch(`http://192.168.1.20:5050/api/kalkulationen/${id}`, {
                                    method: 'DELETE',
                                    headers: { 'Content-Type': 'application/json' }
                                });
                                if (!res.ok) errors.push(id);
                            } catch (err) {
                                errors.push(id);
                            }
                        }
                        setSelectedRows([]);
                        await loadKalkulationen();
                        if (errors.length === 0) {
                            setDeleteError("");
                            alert('Löschen erfolgreich!');
                        } else {
                            setDeleteError('Folgende Einträge konnten nicht gelöscht werden: ' + errors.join(", "));
                        }
                    } catch (e) {
                        console.log("Fehler beim Löschen:", e);
                        setDeleteError("Fehler beim Löschen: " + e.message);
                    }
                }, [selectedRows]);

                const handleLoadSelected = React.useCallback(() => {
                    if (selectedRows.length === 0) return;
                    // Finde alle ausgewählten Artikel
                    const selectedArtikel = [];
                    savedCalculations.forEach(kalk => {
                        kalk.artikel.forEach(row => {
                            if (selectedRows.includes(row.id)) {
                                selectedArtikel.push({
                                    interneNummer: row.angebotsnummer || '',
                                    kundenname: row.kundenname || '',
                                    ekJePreiseinheit: row.ek_je_pe || 0,
                                    mengeNum: row.menge || 0,
                                    anzahlPaletten: row.paletten || 0,
                                    aufschlagProzent: row.aufschlag || 0,
                                    einheit: 1000, // Standardwert, ggf. anpassen
                                    anteiligeFracht: row.anteilige_fracht || 0,
                                    lagerkostenProEinheit: 0, // Standardwert, ggf. anpassen
                                    ersteller: row.ersteller || kalk.ersteller || 'unbekannt' // Ersteller-Information hinzufügen
                                });
                            }
                        });
                    });
                    setArtikelListe(selectedArtikel);
                    // Optional: Datenbank-Ansicht schließen
                    // setShowDatabase(false);
                }, [selectedRows, savedCalculations]);

                // Sortierfunktion
                const handleSort = (field) => {
                    if (sortField === field) {
                        // Richtung umkehren, wenn das gleiche Feld nochmal geklickt wird
                        setSortDirection(sortDirection * -1);
                    } else {
                        // Neues Feld, Standard-Richtung (aufsteigend)
                        setSortField(field);
                        setSortDirection(1);
                    }
                };
                
                // Sortierte und gefilterte Artikelliste
                let sortedAndFilteredArtikel = [...filteredArtikel];
                
                if (sortField) {
                    sortedAndFilteredArtikel.sort((a, b) => {
                        let aValue = a[sortField];
                        let bValue = b[sortField];
                        
                        // Sonderbehandlung für numerische Felder
                        if (typeof aValue === 'string' && typeof bValue === 'string') {
                            return sortDirection * aValue.localeCompare(bValue);
                        } else {
                            // Numerischer Vergleich
                            if (aValue < bValue) return -1 * sortDirection;
                            if (aValue > bValue) return 1 * sortDirection;
                            return 0;
                        }
                    });
                }

                return (
                    <div style={{ marginTop: 20, padding: 20, background: '#fff', borderRadius: 8, boxShadow: '0 1px 3px rgba(0,0,0,0.1)', maxWidth: '1350px', width: '100%' }}>
                        <h2 style={{fontSize:'15px'}}>Datenbank-Übersicht</h2>
                        {deleteError && (
                            <div style={{color: 'red', fontWeight: 'bold', marginBottom: 10}}>
                                {deleteError}
                                        </div>
                        )}
                        <div style={{display:'flex',justifyContent:'flex-end',gap:10,marginBottom:10}}>
                            <button 
                                type="button"
                                onClick={handleLoadSelected}
                                disabled={selectedRows.length === 0}
                                style={{
                                    background: selectedRows.length === 0 ? '#ccc' : '#1a3b6e',
                                    color: '#fff',
                                    fontWeight: 'bold',
                                    border: 'none',
                                    borderRadius: 5,
                                    padding: '5px 12px',
                                    fontSize: '13px',
                                    cursor: selectedRows.length === 0 ? 'not-allowed' : 'pointer'
                                }}
                            >
                                Ausgewählte laden
                            </button>
                            <button 
                                type="button"
                                onClick={handleDeleteSelected} 
                                disabled={selectedRows.length === 0}
                                style={{
                                    background: selectedRows.length === 0 ? '#ccc' : '#dc2626',
                                    color: '#fff',
                                    fontWeight: 'bold',
                                    border: 'none',
                                    borderRadius: 5,
                                    padding: '5px 12px',
                                    fontSize: '13px',
                                    cursor: selectedRows.length === 0 ? 'not-allowed' : 'pointer'
                                }}
                            >
                                Ausgewählte löschen
                            </button>
                                    </div>
                        
                        {/* Filteroptionen hinzufügen */}
                        <div style={{display: 'flex', gap: '10px', marginBottom: '15px'}}>
                            <div style={{flex: '1'}}>
                                <label style={{display: 'block', marginBottom: '5px', fontSize: '12px', fontWeight: 'bold'}}>Ersteller:</label>
                                <input 
                                    type="text" 
                                    value={filterEsteller} 
                                    onChange={e => setFilterErsteller(e.target.value)}
                                    style={{width: '100%', padding: '5px', borderRadius: '4px', border: '1px solid #bfc9d1', fontSize: '13px'}}
                                    placeholder="Nach Ersteller filtern..."
                                />
                                </div>
                            <div style={{flex: '1'}}>
                                <label style={{display: 'block', marginBottom: '5px', fontSize: '12px', fontWeight: 'bold'}}>Kunde:</label>
                                <input 
                                    type="text" 
                                    value={filterKunde} 
                                    onChange={e => setFilterKunde(e.target.value)}
                                    style={{width: '100%', padding: '5px', borderRadius: '4px', border: '1px solid #bfc9d1', fontSize: '13px'}}
                                    placeholder="Nach Kunde filtern..."
                                />
                                            </div>
                            <div style={{flex: '1'}}>
                                <label style={{display: 'block', marginBottom: '5px', fontSize: '12px', fontWeight: 'bold'}}>Angebotsnummer:</label>
                                <input 
                                    type="text" 
                                    value={filterAngebotsnummer} 
                                    onChange={e => setFilterAngebotsnummer(e.target.value)}
                                    style={{width: '100%', padding: '5px', borderRadius: '4px', border: '1px solid #bfc9d1', fontSize: '13px'}}
                                    placeholder="Nach Angebotsnummer filtern..."
                                />
                                        </div>
                                    </div>
                        
                        <div className="table-responsive" style={{margin: '0', padding: '0', overflow: 'visible'}}>
                            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize:'13px' }}>
                                <thead>
                                    <tr style={{ backgroundColor: '#1a3b6e', color: 'white' }}>
                                        <th style={{width: '30px', borderRight: '1px solid #dee2e6'}}></th>
                                        <th onClick={() => handleSort('angebotsnummer')} style={{cursor: 'pointer', position: 'relative', padding: '6px 4px', whiteSpace: 'nowrap', borderRight: '1px solid #dee2e6'}}>
                                            Angebotsnummer
                                            {sortField === 'angebotsnummer' && (
                                                <span style={{marginLeft: '5px'}}>{sortDirection === 1 ? '▲' : '▼'}</span>
                                            )}
                                        </th>
                                        <th onClick={() => handleSort('kundenname')} style={{cursor: 'pointer', position: 'relative', padding: '6px 4px', whiteSpace: 'nowrap', borderRight: '1px solid #dee2e6'}}>
                                            Kundenname
                                            {sortField === 'kundenname' && (
                                                <span style={{marginLeft: '5px'}}>{sortDirection === 1 ? '▲' : '▼'}</span>
                                            )}
                                        </th>
                                        <th onClick={() => handleSort('ersteller')} style={{cursor: 'pointer', position: 'relative', padding: '6px 4px', whiteSpace: 'nowrap', borderRight: '1px solid #dee2e6'}}>
                                            Ersteller
                                            {sortField === 'ersteller' && (
                                                <span style={{marginLeft: '5px'}}>{sortDirection === 1 ? '▲' : '▼'}</span>
                                            )}
                                        </th>
                                        <th onClick={() => handleSort('menge')} style={{cursor: 'pointer', position: 'relative', padding: '6px 4px', whiteSpace: 'nowrap', borderRight: '1px solid #dee2e6'}}>
                                            Menge
                                            {sortField === 'menge' && (
                                                <span style={{marginLeft: '5px'}}>{sortDirection === 1 ? '▲' : '▼'}</span>
                                            )}
                                        </th>
                                        <th onClick={() => handleSort('paletten')} style={{cursor: 'pointer', position: 'relative', padding: '6px 4px', whiteSpace: 'nowrap', borderRight: '1px solid #dee2e6'}}>
                                            Paletten
                                            {sortField === 'paletten' && (
                                                <span style={{marginLeft: '5px'}}>{sortDirection === 1 ? '▲' : '▼'}</span>
                                            )}
                                        </th>
                                        <th onClick={() => handleSort('ek_je_pe')} style={{cursor: 'pointer', position: 'relative', padding: '6px 4px', whiteSpace: 'nowrap', borderRight: "1px solid #dee2e6"}}>
                                            EK je PE
                                            {sortField === 'ek_je_pe' && (
                                                <span style={{marginLeft: '5px'}}>{sortDirection === 1 ? '▲' : '▼'}</span>
                                            )}
                                        </th>
                                        <th onClick={() => handleSort('einkaufssumme')} style={{cursor: 'pointer', position: 'relative', padding: '6px 4px', whiteSpace: 'nowrap', borderRight: '1px solid #dee2e6'}}>
                                            Einkaufssumme
                                            {sortField === 'einkaufssumme' && (
                                                <span style={{marginLeft: '5px'}}>{sortDirection === 1 ? '▲' : '▼'}</span>
                                            )}
                                        </th>
                                        <th onClick={() => handleSort('verkaufssumme')} style={{cursor: 'pointer', position: 'relative', padding: '6px 4px', whiteSpace: 'nowrap', borderRight: '1px solid #dee2e6'}}>
                                            Verkaufssumme
                                            {sortField === 'verkaufssumme' && (
                                                <span style={{marginLeft: '5px'}}>{sortDirection === 1 ? '▲' : '▼'}</span>
                                            )}
                                        </th>
                                        <th onClick={() => handleSort('vk_je_pe')} style={{cursor: 'pointer', position: 'relative', padding: '6px 4px', whiteSpace: 'nowrap', borderRight: "1px solid #dee2e6"}}>
                                            VK je PE
                                            {sortField === 'vk_je_pe' && (
                                                <span style={{marginLeft: '5px'}}>{sortDirection === 1 ? '▲' : '▼'}</span>
                                            )}
                                        </th>
                                        <th onClick={() => handleSort('aufschlag')} style={{cursor: 'pointer', position: 'relative', padding: '6px 4px', whiteSpace: 'nowrap', borderRight: '1px solid #dee2e6'}}>
                                            Aufschlag %
                                            {sortField === 'aufschlag' && (
                                                <span style={{marginLeft: '5px'}}>{sortDirection === 1 ? '▲' : '▼'}</span>
                                            )}
                                        </th>
                                        <th onClick={() => handleSort('anteilige_fracht')} style={{cursor: 'pointer', position: 'relative', padding: '6px 4px', whiteSpace: 'nowrap', borderRight: "1px solid #dee2e6"}}>
                                            anteilige Fracht
                                            {sortField === 'anteilige_fracht' && (
                                                <span style={{marginLeft: '5px'}}>{sortDirection === 1 ? '▲' : '▼'}</span>
                                            )}
                                        </th>
                                        <th onClick={() => handleSort('db_gesamt')} style={{cursor: 'pointer', position: 'relative', padding: '6px 4px', whiteSpace: 'nowrap'}}>
                                            DB gesamt
                                            {sortField === 'db_gesamt' && (
                                                <span style={{marginLeft: '5px'}}>{sortDirection === 1 ? '▲' : '▼'}</span>
                                            )}
                                        </th>
                                    </tr>
                                </thead>
                                                                    <tbody>
                                    {sortedAndFilteredArtikel.map(row => (
                                        <tr key={row.id} style={{ borderBottom: '1px solid #bfc9d1' }}>
                                            <td style={{textAlign: 'center', padding: '4px 4px', borderRight: '1px solid #dee2e6'}}>
                                                <input 
                                                    type="checkbox" 
                                                    checked={selectedRows.includes(row.id)} 
                                                    onChange={e => handleCheckboxChange(row.id, e.target.checked)}
                                                    style={{ 
                                                        cursor: 'pointer',
                                                        width: '16px',
                                                        height: '16px'
                                                    }}
                                                />
                                            </td>
                                            <td style={{padding: '4px 4px', borderRight: '1px solid #dee2e6'}}>{row.angebotsnummer}</td>
                                            <td style={{padding: '4px 4px', borderRight: '1px solid #dee2e6'}}>{row.kundenname}</td>
                                            <td style={{padding: '4px 4px', borderRight: '1px solid #dee2e6'}}>{row.ersteller}</td>
                                            <td style={{padding: '4px 4px', borderRight: '1px solid #dee2e6'}}>{row.menge}</td>
                                            <td style={{padding: '4px 4px', borderRight: '1px solid #dee2e6'}}>{row.paletten}</td>
                                            <td style={{padding: '4px 4px', borderRight: '1px solid #dee2e6'}}>€{formatDE(row.ek_je_pe)}</td>
                                                                                                                    <td style={{padding: '4px 4px', borderRight: '1px solid #dee2e6'}}>€{formatDE(row.einkaufssumme || row.gesamtEK)}</td>
                                            <td style={{padding: '4px 4px', borderRight: '1px solid #dee2e6'}}>€{formatDE(row.verkaufssumme)}</td>
                                            <td style={{padding: '4px 4px', borderRight: '1px solid #dee2e6'}}>€{formatDE(row.vk_je_pe)}</td>
                                            <td style={{padding: '4px 4px', borderRight: '1px solid #dee2e6'}}>{formatDE1(row.aufschlag || 0)}</td>
                                            <td style={{padding: '4px 4px', borderRight: '1px solid #dee2e6'}}>{row.anteilige_fracht > 0 ? '€' + formatDE(row.anteilige_fracht) : '-'}</td>
                                            <td style={{padding: '4px 4px'}}>€{formatDE(row.db_gesamt)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                                </div>
                            </div>
                );
            }

                        // Button-Leiste oben (jetzt innerhalb von React)
            const ButtonLeiste = () => (
                <div className="tab-bar-container">
                    <button 
                        className={`nav-link ${activeTab === "kalkulation" ? "active" : ""}`} 
                        onClick={() => switchTab("kalkulation")}
                    >
                        <i className="bi bi-calculator"></i> Kalkulation
                    </button>
                    <button 
                        className={`nav-link ${activeTab === "datenbank" ? "active" : ""}`} 
                        onClick={() => switchTab("datenbank")}
                    >
                        <i className="bi bi-server"></i> Datenbank
                    </button>
                        </div>
            );

            // Avatar-Map wie auf index.html
            const avatarMap = {
                'admin': 'https://randomuser.me/api/portraits/men/1.jpg',
                'petra': 'https://randomuser.me/api/portraits/women/2.jpg',
                'jürgen': 'https://randomuser.me/api/portraits/men/3.jpg',
                'nizia': 'https://randomuser.me/api/portraits/women/4.jpg',
                'fatih': 'https://randomuser.me/api/portraits/men/5.jpg',
                'silas': 'https://randomuser.me/api/portraits/men/6.jpg',
                'julian': 'https://randomuser.me/api/portraits/men/7.jpg'
            };

            React.useEffect(() => {
                // Benutzername aus localStorage holen
                const loggedInUser = localStorage.getItem('loggedInUser');
                if (loggedInUser) {
                    // Ersten Buchstaben groß
                    const usernameDisplay = loggedInUser.charAt(0).toUpperCase() + loggedInUser.slice(1);
                    const userNameSpan = document.getElementById('userName');
                    if (userNameSpan) userNameSpan.textContent = usernameDisplay;
                    // Avatar setzen
                    const userAvatar = document.getElementById('userAvatar');
                    if (userAvatar) userAvatar.src = avatarMap[loggedInUser.toLowerCase()] || 'https://randomuser.me/api/portraits/lego/1.jpg';
                    

                }
            }, []);

            // Funktion zum Entfernen eines Artikels aus der Liste
            function removeArtikel(index) {
                if (window.confirm('Möchten Sie diesen Artikel wirklich aus der Sendung entfernen?')) {
                    setArtikelListe(prev => {
                        const newList = [...prev];
                        newList.splice(index, 1);
                        return newList;
                    });
                    setDummyState(s => s + 1); // Re-Render erzwingen
                    
                    // Falls die Liste leer sein sollte, Versand deaktivieren
                    if (artikelListe.length <= 1) {
                        setVersandAktiv(false);
                        setSendungsVersandkosten(0);
                    }
                }
            }

            // Berechnung bei Änderung der Eingaben
            React.useEffect(() => {
                if (ek && preiseinheit && aufschlag) {
                    const ekNum = parseFloat(ek) || 0;
                    const pe = parseFloat(preiseinheit) || 1;
                    const aufschlagNum = parseFloat(aufschlag) || 0;
                    // Berechnung ohne vkWunsch
                    const frachtProEinheit = frachtkosten.proEinheit || 0;
                    const lagerJePE = lagerkosten.proEinheit || 0;
                    const ekMitFrachtUndLager = ekNum + frachtProEinheit + lagerJePE;
                    const vk = ekMitFrachtUndLager * (1 + (aufschlagNum / 100));
                    
                    // ... existierender Code ...
                }
            }, [ek, preiseinheit, aufschlag, menge, stueckProPalette, frachtkosten.gesamt]);

            // Tab wechseln und Datenbank laden, wenn nötig
            const switchTab = async (tab) => {
                setActiveTab(tab);
                if (tab === "datenbank") {
                    // Datenbank anzeigen und bei Bedarf laden
                    await loadKalkulationen();
                    setShowDatabase(true);
                } else {
                    // Datenbank ausblenden
                    setShowDatabase(false);
                }
            };

            return (
                <div className="main-flex-container">
                    <div className="button-leiste">
                        {/* Leere Button-Leiste links */}
                    </div>
                    
                    <div style={{width: '1210px'}}>
                        {/* Tab-Bar über dem Inhalt */}
                        <div style={{marginBottom: '0px'}}>
                            <ButtonLeiste />
                        </div>
                        
                        {activeTab === "kalkulation" ? (
                        <div className="w-100" style={{maxWidth: '1350px', position: 'relative'}}>
                            <div className="kalk-flex">
                                {/* Kundendaten Card */}
                                <div className="kalk-card">
                                    <h3>Kundendaten</h3>
                                    <label htmlFor="interneNummer">Interne Angebotsnummer:</label>
                                    <input 
                                        type="text" 
                                        id="interneNummer" 
                                        value={interneNummer}
                                        onChange={(e) => setInterneNummer(e.target.value)}
                                        placeholder="z.B. AN-001"
                                    />
                                    <div style={{color: '#dc2626', fontSize: '0.8rem', marginTop: '-5px', marginBottom: '5px'}}>Bitte ausfüllen</div>
                                    
                                    <label htmlFor="kundenname">Kundenname:</label>
                                    <input 
                                        type="text" 
                                        id="kundenname" 
                                        value={kundenname}
                                        onChange={(e) => setKundenname(e.target.value)}
                                        placeholder="Kundenname"
                                    />
                                    <div style={{color: '#dc2626', fontSize: '0.8rem', marginTop: '-5px', marginBottom: '5px'}}>Bitte ausfüllen</div>
                                    
                                    <div style={{display: 'flex', alignItems: 'center', marginTop: '5px', marginBottom: '10px', backgroundColor: '#f0f4f8', padding: '6px', borderRadius: '4px'}}>
                                        <input 
                                            type="checkbox" 
                                            id="behalteKundendaten" 
                                            checked={behalteKundendaten}
                                            onChange={(e) => setBehalteKundendaten(e.target.checked)}
                                            style={{
                                                width: 'auto',
                                                marginRight: '4px',
                                                cursor: 'pointer'
                                            }}
                                        />
                                        <label 
                                            htmlFor="behalteKundendaten" 
                                            style={{
                                                margin: '0',
                                                fontSize: '0.85rem',
                                                fontWeight: 'normal',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            Angebotsnummer und Kundenname beibehalten
                                        </label>
                                    </div>
                                    
                                    {/* Kalkulationsergebnis Box */}
                                    <div style={{backgroundColor: '#f0f4f8', padding: '10px', borderRadius: '5px', marginTop: '10px', marginBottom: '10px'}}>
                                        <div style={{fontWeight: 'bold', marginBottom: '5px'}}>Kalkulationsergebnis:</div>
                                        <div><strong>VK je PE:</strong> €{formatDE(aktuellesErgebnis.vkJePreiseinheit || 0)}</div>
                                        <div><strong>VK:</strong> €{formatDE(aktuellesErgebnis.gesamtVK || 0)}</div>
                                        <div><strong>DB gesamt:</strong> €{formatDE(aktuellesErgebnis.dbGesamt || 0)}</div>
                                        <div><strong>Paletten:</strong> {aktuellesErgebnis.anzahlPaletten || 0}</div>
                                        <div><strong>Frachtkosten (Sendung):</strong> €{formatDE(sendungsVersandkosten || 0)}</div>
                                        <div style={{marginTop: '5px'}}><strong>Lager gesamt:</strong> €{formatDE(lagerkosten.gesamt || 0)} | je PE: €{formatDE(lagerkosten.proEinheit || 0)}</div>
                                    </div>
                                    
                                                                    <div style={{display: 'flex', justifyContent: 'center', width: '100%', marginTop: '15px'}}>
                                    <button 
                                        type="button" 
                                        className="btn btn-primary"
                                        onClick={artikelZurSendungHinzufuegen}
                                        style={{
                                            backgroundColor: '#1a3b6e', 
                                            borderColor: '#1a3b6e',
                                            padding: '8px 15px',
                                            fontSize: '0.9rem',
                                            maxWidth: '220px',
                                            width: 'auto'
                                        }}
                                    >
                                        <i className="bi bi-plus-lg me-1"></i>
                                        Hinzufügen
                        </button>
                                </div>
                                </div>
                                
                                {/* Kalkulation Card */}
                                <div className="kalk-card">
                                    <h3>Kalkulation</h3>
                                    <label htmlFor="ekField">EK je Preiseinheit:</label>
                                    <input 
                                        type="text" 
                                        id="ekField" 
                                        value={ek}
                                        onChange={(e) => {
                                            // Entferne alle Zeichen außer Zahlen, Punkt und Komma
                                            const cleanValue = e.target.value.replace(/[^0-9.,]/g, '').replace(',', '.');
                                            setEk(cleanValue);
                                        }}
                                        style={{
                                            width: '100%',
                                            border: '1px solid #bfc9d1',
                                            borderRadius: '5px',
                                            padding: '5px 8px',
                                            minHeight: '34px',
                                            marginBottom: '6px'
                                        }}
                                    />
                                    
                                    <label htmlFor="preiseinheitSelect">Preiseinheit:</label>
                                    <select 
                                        id="preiseinheitSelect"
                                        value={preiseinheit}
                                        onChange={(e) => setPreiseinheit(e.target.value)}
                                    >
                                        <option value="1">1 Stück</option>
                                        <option value="100">100 Stück</option>
                                        <option value="1000">1.000 Stück</option>
                                    </select>
                                    
                                    <label htmlFor="mengeField">Menge:</label>
                                    <input 
                                        type="number" 
                                        id="mengeField" 
                                        value={menge}
                                        onChange={(e) => setMenge(e.target.value)}
                                    />
                                    
                                    <label htmlFor="stueckField">Stück pro Palette:</label>
                                    <input 
                                        type="number" 
                                        id="stueckField" 
                                        value={stueckProPalette}
                                        onChange={(e) => setStueckProPalette(e.target.value)}
                                    />
                                    
                                    <label htmlFor="aufschlagField">Aufschlag in %:</label>
                                    <input 
                                        type="text" 
                                        id="aufschlagField" 
                                        value={aufschlag}
                                        onChange={(e) => {
                                            // Entferne alle Zeichen außer Zahlen, Punkt und Komma
                                            const cleanValue = e.target.value.replace(/[^0-9.,]/g, '').replace(',', '.');
                                            setAufschlag(cleanValue);
                                        }}
                                        style={{
                                            width: '100%',
                                            border: '1px solid #bfc9d1',
                                            borderRadius: '5px',
                                            padding: '5px 8px',
                                            minHeight: '34px',
                                            marginBottom: '6px'
                                        }}
                                    />
                                </div>
                                
                                {/* Versand Card */}
                                <div className="kalk-card">
                                    <h3>Versand</h3>
                                                                        <label htmlFor="versandartSelect">Versandart:</label>
                                    <select 
                                        id="versandartSelect"
                                        value={versandart}
                                        onChange={(e) => {
                                            setVersandart(e.target.value);
                                            // Entfernungswerte zurücksetzen, wenn auf Spedition oder Stückgut gewechselt wird
                                            if (e.target.value === "spedition" || e.target.value === "stueckgut") {
                                                setEntfernungStatus("");
                                                setStrecke("");
                                            }
                                        }}
                                        disabled={!versandAktiv}
                                    >
                                        <option value="lkw">LKW (max. 15 Paletten)</option>
                                        <option value="lkwZug">LKW-Zug</option>
                                        <option value="bus">Bus</option>
                                        <option value="spedition">Spedition (Fixpreis)</option>
                                        <option value="stueckgut">Stückgut (nach PLZ-Tabelle)</option>
                                    </select>
                                    
                                    {/* Adresse und Entfernungsberechnung nur für LKW, LKW-Zug und Bus anzeigen */}
                                    {(versandart === "lkw" || versandart === "lkwZug" || versandart === "bus") && (
                                        <>
                                            <label htmlFor="adresseFeld">Firmenname oder Kundenadresse:</label>
                                            <input 
                                                type="text" 
                                                id="adresseFeld" 
                                                value={adresseFeld}
                                                onChange={(e) => setAdresseFeld(e.target.value)}
                                                placeholder="z.B. Musterstraße 5, 12345 Berlin"
                                                disabled={!versandAktiv}
                                            />
                                            
                                            <button 
                                                type="button" 
                                                className="btn btn-info mt-2 mb-2"
                                                onClick={async () => {
                                                    try {
                                                        setEntfernungStatus("Berechne Strecke auf Straßen...");
                                                        // Geocode der Kundenadresse
                                                        const kundenKoordinaten = await geocodeAdresse(adresseFeld);
                                                        // Geocode der Firmenadresse
                                                        const firmenKoordinaten = await geocodeAdresse(FIRMENADRESSE);
                                                        
                                                        // OpenRouteService API für tatsächliche Straßenentfernung nutzen
                                                        const startCoord = firmenKoordinaten.join(',');
                                                        const endCoord = kundenKoordinaten.join(',');
                                                        
                                                        // URL für Directions API erstellen
                                                        const routeUrl = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${API_KEY_ORS}&start=${startCoord}&end=${endCoord}`;
                                                        
                                                        // Routenanfrage senden
                                                        const routeRes = await fetch(routeUrl);
                                                        const routeData = await routeRes.json();
                                                        
                                                        // Entfernung aus der Route extrahieren (in Metern) und in Kilometer umrechnen
                                                        let distance = 0;
                                                        if (routeData.features && routeData.features.length > 0) {
                                                            distance = Math.round(routeData.features[0].properties.summary.distance / 1000); // Umrechnung m -> km
                                                        } else {
                                                            throw new Error('Keine Route gefunden');
                                                        }
                                                        
                                                        // Update der Strecke im State
                                                        setStrecke(distance.toString());
                                                        setEntfernungStatus(`Entfernung: ${distance} km`);
                                                    } catch (error) {
                                                        console.error("Fehler bei der Entfernungsberechnung:", error);
                                                        setEntfernungStatus("Fehler: " + error.message);
                                                        alert("Fehler bei der Entfernungsberechnung: " + error.message);
                                                    }
                                                }}
                                                disabled={!versandAktiv || !adresseFeld}
                                                style={{backgroundColor: '#6c91c2', borderColor: '#6c91c2'}}
                                            >
                                                Entfernung berechnen
                        </button>
                                            
                                            {entfernungStatus && (
                                                <div style={{
                                                    fontSize: '0.85rem',
                                                    margin: '5px 0',
                                                    color: entfernungStatus.includes('Fehler') ? '#dc3545' : '#28a745',
                                                    fontWeight: '500'
                                                }}>
                                                    {entfernungStatus}
                                                </div>
                                            )}
                                            
                                            <label htmlFor="streckeField">Strecke (km):</label>
                                            <input 
                                                type="number" 
                                                id="streckeField" 
                                                value={strecke}
                                                onChange={(e) => setStrecke(e.target.value)}
                                                disabled={!versandAktiv}
                                            />
                                        </>
                                    )}
                                    
                                    {versandart === "stueckgut" && (
                                        <>
                                            <label htmlFor="plzField">PLZ:</label>
                                            <input 
                                                type="text" 
                                                id="plzField" 
                                                value={plz}
                                                onChange={(e) => setPlz(e.target.value)}
                                                disabled={!versandAktiv}
                                            />
                                        </>
                                    )}
                                    
                                    {versandart === "spedition" && (
                                        <>
                                            <label htmlFor="speditionField">Speditionskosten (€):</label>
                                            <input 
                                                type="number" 
                                                id="speditionField" 
                                                value={spedition}
                                                onChange={(e) => setSpedition(e.target.value)}
                                                disabled={!versandAktiv}
                                            />
                                        </>
                                    )}
                                    
                                                                        <div style={{backgroundColor: '#f0f4f8', padding: '10px', borderRadius: '5px', marginTop: '10px', marginBottom: '10px'}}>
                                        <div style={{fontWeight: 'bold', marginBottom: '5px'}}>Frachtkosten:</div>
                                        <div><strong>Gesamt:</strong> €{formatDE(frachtkosten.gesamt || 0)}</div>
                                        {versandart === "lkw" && (
                                            <div style={{fontSize: '0.9rem'}}>Preis pro km: €1,35</div>
                                        )}
                                        {versandart === "lkwZug" && (
                                            <div style={{fontSize: '0.9rem'}}>Preis pro km: €1,60</div>
                                        )}
                                        {versandart === "bus" && (
                                            <div style={{fontSize: '0.9rem'}}>Preis pro km: €0,80</div>
                                        )}
                                        {(versandart === "lkw" || versandart === "lkwZug" || versandart === "bus") && (
                                            <div style={{fontSize: '0.9rem'}}>Hin- und Rückfahrt: {strecke ? `${strecke} km × 2` : '0 km × 2'}</div>
                                        )}
                                        {versandart === "spedition" && (
                                            <div style={{fontSize: '0.9rem'}}>Fixpreis für Spedition: €{formatDE(parseFloat(spedition) || 0)}</div>
                                        )}
                                        {versandart === "stueckgut" && (
                                            <div>
                                                <div style={{fontSize: '0.9rem'}}>Stückguttarif nach PLZ: {plz}</div>
                                                <div style={{fontSize: '0.9rem'}}>Basispreis: €{formatDE(frachtkosten.basis || 0)}</div>
                                                <div style={{fontSize: '0.9rem'}}>Preiserhöhung: €{formatDE(frachtkosten.preiserhoehung || 0)}</div>
                                                <div style={{fontSize: '0.9rem'}}>Dieselzuschlag: €{formatDE(frachtkosten.dieselzuschlag || 0)}</div>
                                                <div style={{fontSize: '0.9rem'}}>Palettentausch: €{formatDE(frachtkosten.palettentausch || 0)}</div>
                                            </div>
                                        )}
                                        {(versandart === "lkw" || versandart === "lkwZug" || versandart === "bus") && entfernungStatus && entfernungStatus.includes("Entfernung:") && (
                                            <div style={{fontSize: '0.9rem', color: '#0d6efd'}}>Berechnung auf Basis der schnellsten Straßenroute</div>
                                        )}
                                        <div style={{fontSize: '0.9rem'}}>Paletten: {frachtkosten.paletten || 1}</div>
                            </div>
                                    
                                    <div style={{ marginTop: '10px', marginBottom: '5px', backgroundColor: '#f0f4f8', padding: '2px', borderRadius: '4px', display: 'inline-block' }}>
        <label style={{ display: 'inline-flex', alignItems: 'center', fontSize: '0.8rem', whiteSpace: 'nowrap', margin: '0' }}>
            <input
                type="checkbox"
                id="volleFrachtJePosition"
                checked={volleFrachtJePosition}
                onChange={e => setVolleFrachtJePosition(e.target.checked)}
                disabled={!versandAktiv}
                                style={{ 
                    marginRight: '0px', 
                    transform: 'scale(0.8)'
                }}
            />
         <span style={{ marginLeft: '0px' }}>Fracht komplett</span>
        </label>
    </div>
                                    
                                    <div style={{display: 'flex', justifyContent: 'center', width: '100%', marginTop: '10px'}}>
                                        <button 
                                            type="button" 
                                            className="btn btn-info"
                                            onClick={berechneSendungsVersandkosten}
                                            disabled={!versandAktiv}
                                            style={{
                                                backgroundColor: '#6bb4c9', 
                                                borderColor: '#6bb4c9',
                                                padding: '8px 15px',
                                                fontSize: '0.9rem',
                                                maxWidth: '180px',
                                                width: 'auto'
                                            }}
                                        >
                                            <i className="bi bi-truck me-1"></i>
                                            Berechnen
                        </button>
                                    </div>
                                </div>
                                
                                {/* Lagerung Card - NEU */}
                                <div className="kalk-card">
                                    <h3>Lagerung</h3>
                                    <label htmlFor="lagerPalettenField">Anzahl Paletten:</label>
                                    <div style={{position: 'relative'}}>
                                        <input 
                                            type="number" 
                                            id="lagerPalettenField" 
                                            value={aktuellesErgebnis.anzahlPaletten || 0}
                                            readOnly
                                            tabIndex="-1"
                                            style={{
                                                backgroundColor: '#f0f4f8',
                                                cursor: 'not-allowed'
                                            }}
                                        />
                                    </div>
                                    
                                    <label htmlFor="lagerDauerField">Lagerdauer (Monate):</label>
                                    <input 
                                        type="number" 
                                        id="lagerDauerField" 
                                        value={lagerDauer}
                                        onChange={(e) => setLagerDauer(e.target.value)}
                                    />
                                    
                                    <label htmlFor="lagerGebuehrField">Lagergebühr je Palette/Monat (€):</label>
                                    <input 
                                        type="number" 
                                        id="lagerGebuehrField" 
                                        step="0.1"
                                        value={lagerGebuehr}
                                        onChange={(e) => setLagerGebuehr(e.target.value)}
                                    />
                                    
                                    <div style={{backgroundColor: '#f0f4f8', padding: '10px', borderRadius: '5px', marginTop: '10px', marginBottom: '10px'}}>
                                        <div style={{fontWeight: 'bold', marginBottom: '5px'}}>Lagerkosten-Ergebnis:</div>
                                        <div><strong>Paletten:</strong> {lagerkosten.paletten || 0}
                                            {!lagerPaletten && aktuellesErgebnis.anzahlPaletten > 0 && (
                                                <span style={{color: '#0d6efd', fontSize: '0.85rem', marginLeft: '5px'}}>
                                                    (aus Berechnung übernommen)
                                                </span>
                                            )}
                                        </div>
                                        <div><strong>Dauer:</strong> {lagerDauer || 0} Monate</div>
                                        <div><strong>Lagerkosten gesamt:</strong> €{formatDE(lagerkosten.gesamt || 0)}</div>
                                        <div><strong>Lagerkosten je PE:</strong> €{formatDE(lagerkosten.proEinheit || 0)}</div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Aktionsbuttons - immer über der Artikelliste */}
                            <div className="d-flex justify-content-end mt-4 mb-3 gap-3">
                                <button 
                                    type="button" 
                                    className="btn btn-success"
                                    onClick={saveKalkulation}
                                >
                                    <i className="bi bi-save me-2"></i>
                            Speichern
                        </button>
                                <button 
                                    type="button" 
                                    className="btn btn-primary pdf-button"
                                    onClick={exportierePDF}
                                >
                                    <i className="bi bi-file-earmark-pdf me-2"></i>
                                    PDF erstellen
                                </button>
                                <button 
                                    type="button" 
                                    className="btn btn-danger reset-button"
                                    onClick={resetForm}
                                >
                                    <i className="bi bi-arrow-counterclockwise me-2"></i>
                                    Zurücksetzen
                                </button>
                            </div>
                            
                            {/* Artikelliste */}
                            {artikelListe.length > 0 && (
                                <div id="artikel-tabelle" className="mt-2" style={{maxWidth: '1450px', width: '100%', overflow: 'visible', paddingLeft: 0}}>
                                    <h5 style={{fontSize: '0.9rem', fontWeight: 'bold', margin: '3px 0', textTransform: 'uppercase', letterSpacing: '0.5px'}}>Artikel in der Sendung: {artikelListe.length}</h5>
                                    <div style={{margin: '0', padding: '0', paddingLeft: 0, overflow: 'visible', width: '100%'}}>
                                        <table className="table table-hover" style={{
                                            backgroundColor: '#f8f9fa', 
                                            borderRadius: '8px', 
                                            overflow: 'visible', 
                                            width: '100%', 
                                            fontSize: '0.9rem', /* Größere Schriftgröße */
                                            margin: '0',
                                            tableLayout: 'fixed',
                                            borderCollapse: 'collapse'
                                        }}>
                                                    <thead>
                                                                                                    <tr style={{backgroundColor: '#1a3b6e', color: 'white', fontSize: '0.85rem', borderCollapse: 'collapse'}}>
                                                    <th style={{padding: '4px 3px', whiteSpace: 'nowrap', width: '120px', fontSize: '0.85rem', borderRight: '1px solid #fff'}}>Angebotsnummer</th>
                                                    <th style={{padding: '4px 3px', whiteSpace: 'nowrap', width: '110px', fontSize: '0.85rem', borderRight: '1px solid #fff'}}>Kundenname</th>
                                                    <th style={{padding: '4px 3px', whiteSpace: 'nowrap', width: '80px', fontSize: '0.85rem', borderRight: '1px solid #fff', textAlign: 'center'}}>Menge</th>
                                                    <th style={{padding: '4px 3px', whiteSpace: 'nowrap', width: '65px', fontSize: '0.85rem', borderRight: '1px solid #fff', textAlign: 'center'}}>Paletten</th>
                                                    <th style={{padding: '4px 3px', whiteSpace: 'nowrap', width: '90px', fontSize: '0.85rem', borderRight: '1px solid #fff', textAlign: 'center'}}>EK je PE</th>
                                                    <th style={{padding: '4px 3px', whiteSpace: 'nowrap', width: '110px', fontSize: '0.85rem', borderRight: '1px solid #fff', textAlign: 'center'}}>Einkaufssumme</th>
                                                    <th style={{padding: '4px 3px', whiteSpace: 'nowrap', width: '110px', fontSize: '0.85rem', borderRight: '1px solid #fff', textAlign: 'center'}}>Verkaufssumme</th>
                                                    <th style={{padding: '4px 3px', whiteSpace: 'nowrap', width: '100px', fontSize: '0.85rem', borderRight: '1px solid #fff', textAlign: 'center'}}>VK je PE</th>
                                                    <th style={{padding: '4px 3px', whiteSpace: 'nowrap', width: '90px', fontSize: '0.85rem', borderRight: '1px solid #fff', textAlign: 'center'}}>Aufschlag</th>
                                                    <th style={{padding: '4px 3px', whiteSpace: 'nowrap', width: '100px', fontSize: '0.85rem', borderRight: '1px solid #fff', textAlign: 'center'}}>anteilige Fracht</th>
                                                    <th style={{padding: '4px 3px', whiteSpace: 'nowrap', width: '120px', fontSize: '0.85rem', borderRight: '1px solid #fff', textAlign: 'center'}}>DB gesamt</th>
                                                    <th style={{padding: '4px 3px', whiteSpace: 'nowrap', width: '55px', fontSize: '0.85rem', textAlign: 'center'}}>Aktion</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {artikelMitFracht.map((artikel, index) => {
                                                    // Korrigierte Berechnung der Einkaufssumme und Verkaufssumme
                                                    // Basis ist die Menge geteilt durch die Preiseinheit
                                                    const anzahlPreiseinheiten = artikel.mengeNum / artikel.einheit;
                                                    
                                                    // EK Berechnung - basiert auf dem EK je PE mit Fracht und Lager
                                                    // Korrekte Gesamtberechnung
                                                    const basisEK = artikel.ekJePreiseinheit || 0;
                                                    const frachtKosten = artikel.frachtProEinheit || 0;
                                                    const lagerKosten = artikel.lagerkostenProEinheit || 0;
                                                    const korrekteGesamtSumme = basisEK + frachtKosten + lagerKosten;
                                                    
                                                    // Setze korrigierte Werte
                                                    artikel.ekJePreiseinheitMitFracht = korrekteGesamtSumme;
                                                    artikel.einkaufssumme = korrekteGesamtSumme * anzahlPreiseinheiten;
                                                    const gesamtEK = korrekteGesamtSumme * anzahlPreiseinheiten;
                                                    
                                                    // VK Berechnung - basiert auf dem VK je PE 
                                                    const gesamtVK = artikel.vkJePreiseinheit * anzahlPreiseinheiten;
                                                    
                                                    return (
                                                        <tr key={index} style={{borderBottom: '1px solid #dee2e6'}}>
                                                            <td style={{padding: '3px 2px', fontSize: '0.85rem', borderRight: '1px solid #dee2e6'}}>{artikel.interneNummer || ''}</td>
                                                            <td style={{padding: '3px 2px', fontSize: '0.85rem', borderRight: '1px solid #dee2e6'}}>{artikel.kundenname || ''}</td>
                                                            <td style={{padding: '4px 4px', borderRight: '1px solid #dee2e6'}}>
                                                                <input
                                                                                                                                            type="text"
                                                                        value={artikel.mengeNum}
                                                                        onChange={(e) => {
                                                                            // Entferne alle Zeichen außer Zahlen
                                                                            const cleanValue = e.target.value.replace(/[^0-9]/g, '');
                                                                            const newValue = parseInt(cleanValue) || 0;
                                                                            
                                                                            const updateList = [...artikelListe];
                                                                            updateList[index].mengeNum = newValue;
                                                                            // Paletten neu berechnen
                                                                            if (updateList[index].stueckProPalette > 0) {
                                                                                updateList[index].anzahlPaletten = Math.ceil(newValue / updateList[index].stueckProPalette);
                                                                            }

                                                                            // Gesamtmengen-Berechnung
                                                                            const anzahlPreiseinheiten = newValue / updateList[index].einheit;
                                                                            const ekMitFracht = updateList[index].ekJePreiseinheitMitFracht || updateList[index].ekJePreiseinheit;
                                                                            
                                                                            // Alle abhängigen Werte neu berechnen
                                                                            updateList[index].gesamtEK = ekMitFracht * anzahlPreiseinheiten;
                                                                            updateList[index].gesamtVK = updateList[index].vkJePreiseinheit * anzahlPreiseinheiten;
                                                                            updateList[index].dbGesamt = updateList[index].dbJePreiseinheit * anzahlPreiseinheiten;
                                                                            
                                                                            // Sofort aktualisieren
                                                                            setArtikelListe(updateList);
                                                                            berechneSendungsVersandkosten();
                                                                            setDummyState(s => s + 1);
                                                                        }}
                                                                        onKeyDown={(e) => {
                                                                            // Bei Enter-Taste Fokus entfernen (Bestätigung)
                                                                            if (e.key === 'Enter') {
                                                                                e.target.blur();
                                                                            }
                                                                        }}
                                                                        style={{
                                                                            width: '60px', 
                                                                            border: '1px solid #ced4da', 
                                                                            borderRadius: '4px', 
                                                                            padding: '2px 5px',
                                                                            textAlign: 'center',
                                                                            fontSize: '0.85rem'
                                                                        }}
                                                                />
                                                            </td>
                                                            <td style={{padding: '3px 2px', fontSize: '0.85rem', borderRight: '1px solid #dee2e6', textAlign: 'center'}}>{artikel.anzahlPaletten || 0}</td>
                                                            <td style={{padding: '4px 4px', borderRight: '1px solid #dee2e6'}}>
                                                                                                                                    <div style={{display: 'flex', alignItems: 'center', justifyContent: 'center', whiteSpace: 'nowrap', fontSize: '0.85rem'}}>
                                                                        {(() => {
                                                                            // Korrekte Berechnung direkt bei der Anzeige
                                                                            const basisEK = artikel.ekJePreiseinheit || 0;
                                                                            const frachtKosten = artikel.frachtProEinheit || 0;
                                                                            const lagerKosten = artikel.lagerkostenProEinheit || 0;
                                                                            const korrekteGesamtSumme = basisEK + frachtKosten + lagerKosten;
                                                                            return `€${formatDE(korrekteGesamtSumme)}`;
                                                                        })()}
                                                                        <i className="bi bi-info-circle-fill ms-1" 
                                                                           style={{fontSize: '0.75rem', color: '#6c757d', cursor: 'help'}}
                                                                           onClick={() => {
                                                                               const basisEK = artikel.ekJePreiseinheit || 0;
                                                                               const frachtKosten = artikel.frachtProEinheit || 0;
                                                                               const lagerKosten = artikel.lagerkostenProEinheit || 0;
                                                                               // Berechne die Summe korrekt
                                                                               const korrekteGesamtSumme = basisEK + frachtKosten + lagerKosten;
                                                                               const message = `EK je PE Zusammensetzung:\n\nBasis EK je PE: €${formatDE(basisEK)}\n+ Fracht: €${formatDE(frachtKosten)}\n+ Lagerkosten: €${formatDE(lagerKosten)}\n\n= Gesamt EK je PE: €${formatDE(korrekteGesamtSumme)}`;
                                                                               alert(message);
                                                                           }}
                                                                        ></i>
                                                                    </div>
                                                            </td>
                                                            <td style={{padding: '3px 2px', width: '110px', fontSize: '0.85rem', borderRight: '1px solid #dee2e6', textAlign: 'center'}}>
                                                                {(() => {
                                                                    // Korrekte Berechnung der Einkaufssumme
                                                                    const basisEK = artikel.ekJePreiseinheit || 0;
                                                                    const frachtKosten = artikel.frachtProEinheit || 0;
                                                                    const lagerKosten = artikel.lagerkostenProEinheit || 0;
                                                                    const korrekteGesamtSumme = basisEK + frachtKosten + lagerKosten;
                                                                    const anzahlPreiseinheiten = artikel.mengeNum / artikel.einheit;
                                                                    return `€${formatDE(korrekteGesamtSumme * anzahlPreiseinheiten)}`;
                                                                })()}
                                                            </td>
                                                            <td style={{padding: '3px 2px', width: '110px', fontSize: '0.85rem', borderRight: '1px solid #dee2e6', textAlign: 'center'}}>€{formatDE(artikel.gesamtVK || gesamtVK)}</td>
                                                            <td style={{padding: '4px 4px', borderRight: '1px solid #dee2e6'}}>
                                                                <div style={{position: 'relative', width: '105px'}}>
                                                                    <input
                                                                        type="text"
                                                                        value={artikel.tempVKValue !== undefined ? artikel.tempVKValue : parseFloat(artikel.vkJePreiseinheit || artikel.ekJePreiseinheitMitFracht || artikel.ekJePreiseinheit).toFixed(2)}
                                                                        onChange={(e) => {
                                                                            // Entferne alle Zeichen außer Zahlen, Punkt und Komma
                                                                            const inputValue = e.target.value;
                                                                            
                                                                            const updateList = [...artikelListe];
                                                                            // Temporäres Feld für die direkte Anzeige
                                                                            updateList[index].tempVKValue = inputValue;
                                                                            
                                                                            // Nur für gültige Zahlen die Berechnung durchführen
                                                                            const cleanValue = inputValue.replace(/[^0-9.,]/g, '').replace(',', '.');
                                                                            if (!isNaN(parseFloat(cleanValue))) {
                                                                                const newValue = parseFloat(cleanValue) || 0;
                                                                                
                                                                                updateList[index].vkJePreiseinheit = newValue;
                                                                                updateList[index].exactUserVkValue = newValue;
                                                                                // Neu berechnen des Aufschlags
                                                                                const ekMitFracht = updateList[index].ekJePreiseinheitMitFracht || updateList[index].ekJePreiseinheit;
                                                                                
                                                                                // EK mit Fracht neu berechnen
                                                                                const basisEK = updateList[index].ekJePreiseinheit || 0;
                                                                                const frachtKosten = updateList[index].frachtProEinheit || 0;
                                                                                const lagerKosten = updateList[index].lagerkostenProEinheit || 0;
                                                                                const korrekteGesamtSumme = basisEK + frachtKosten + lagerKosten;
                                                                                updateList[index].ekJePreiseinheitMitFracht = korrekteGesamtSumme;
                                                                                
                                                                                // Prüfen, ob der VK gleich dem EK mit Fracht ist (mit Toleranz für Rundungsfehler)
                                                                                if (Math.abs(newValue - korrekteGesamtSumme) < 0.001 || Math.abs(((newValue / korrekteGesamtSumme) - 1) * 100) < 0.1) {
                                                                                    // Bei VK ≈ EK soll der Aufschlag exakt 0% sein
                                                                                    updateList[index].aufschlagProzent = 0.0;
                                                                                    // Und VK sollte genau dem EK entsprechen
                                                                                    updateList[index].vkJePreiseinheit = korrekteGesamtSumme;
                                                                                    updateList[index].exactUserVkValue = korrekteGesamtSumme;
                                                                                } else {
                                                                                    // Sonst normal berechnen (gerundet auf eine Nachkommastelle)
                                                                                    updateList[index].aufschlagProzent = parseFloat((((newValue / korrekteGesamtSumme) - 1) * 100).toFixed(1));
                                                                                }
                                                                                
                                                                                // Neu berechnen der Verkaufssumme
                                                                                const anzahlPreiseinheiten = updateList[index].mengeNum / updateList[index].einheit;
                                                                                updateList[index].gesamtVK = newValue * anzahlPreiseinheiten;
                                                                                
                                                                                // Neu berechnen des DB
                                                                                updateList[index].dbJePreiseinheit = newValue - korrekteGesamtSumme;
                                                                                updateList[index].dbGesamt = updateList[index].dbJePreiseinheit * anzahlPreiseinheiten;

                                                                                // Sofort aktualisieren für Echtzeitberechnung
                                                                                setArtikelListe(updateList);
                                                                                berechneSendungsVersandkosten();
                                                                                setDummyState(s => s + 1);
                                                                            }
                                                                        }}
                                                                        onKeyDown={(e) => {
                                                                            // Bei Enter-Taste Fokus entfernen (Bestätigung)
                                                                            if (e.key === 'Enter') {
                                                                                e.target.blur();
                                                                            }
                                                                        }}
                                                                        onBlur={(e) => {
                                                                            // Beim Verlassen des Feldes den Wert formatieren
                                                                            const updateList = [...artikelListe];
                                                                            // Temporäres Feld löschen und formatierten Wert zeigen
                                                                            delete updateList[index].tempVKValue;
                                                                            setArtikelListe(updateList);
                                                                            setDummyState(s => s + 1); // Force re-render
                                                                        }}
                                                                        style={{
                                                                            width: '85px', 
                                                                            border: '1px solid #0d6efd',
                                                                            borderRadius: '4px', 
                                                                            padding: '1px 1px 1px 22px',
                                                                            fontWeight: 'bold',
                                                                            color: '#0d6efd',
                                                                            fontSize: '0.85rem',
                                                                            textAlign: 'center'
                                                                        }}
                                                                    />
                                                                    <span style={{
                                                                        position: 'absolute',
                                                                        left: '5px',
                                                                        top: '50%',
                                                                        transform: 'translateY(-50%)',
                                                                        color: '#0d6efd',
                                                                        fontWeight: 'bold',
                                                                        fontSize: '0.85rem',
                                                                        pointerEvents: 'none'
                                                                    }}>€</span>
                                                                </div>
                                                            </td>
                                                            <td style={{padding: '4px 4px', borderRight: '1px solid #dee2e6'}}>
                                                                <div style={{position: 'relative', width: '95px'}}>
                                                                    <input
                                                                        type="text"
                                                                        value={artikel.tempAufschlagValue !== undefined ? artikel.tempAufschlagValue : formatDE1(artikel.aufschlagProzent || 0)}
                                                                        onChange={(e) => {
                                                                            // Entferne alle Zeichen außer Zahlen, Punkt und Komma
                                                                            const inputValue = e.target.value;
                                                                            
                                                                            const updateList = [...artikelListe];
                                                                            // Temporäres Feld für die direkte Anzeige
                                                                            updateList[index].tempAufschlagValue = inputValue;
                                                                            
                                                                            // Nur für gültige Zahlen die Berechnung durchführen
                                                                            const cleanValue = inputValue.replace(/[^0-9.,]/g, '').replace(',', '.');
                                                                            if (!isNaN(parseFloat(cleanValue))) {
                                                                                const newValue = parseFloat(cleanValue) || 0;
                                                                                
                                                                                // Speichere den Aufschlagswert (gerundet auf eine Nachkommastelle)
                                                                                updateList[index].aufschlagProzent = parseFloat(newValue.toFixed(1));
                                                                                
                                                                                // Berechne korrekten EK mit Fracht
                                                                                const basisEK = artikel.ekJePreiseinheit || 0;
                                                                                const frachtKosten = artikel.frachtProEinheit || 0;
                                                                                const lagerKosten = artikel.lagerkostenProEinheit || 0;
                                                                                const korrekteGesamtSumme = basisEK + frachtKosten + lagerKosten;
                                                                                
                                                                                // Sicherstellen dass der EK korrekt ist
                                                                                updateList[index].ekJePreiseinheitMitFracht = korrekteGesamtSumme;
                                                                                
                                                                                // Berechne den VK basierend auf dem EK mit Fracht und dem Aufschlag
                                                                                updateList[index].vkJePreiseinheit = korrekteGesamtSumme * (1 + newValue / 100);
                                                                                
                                                                                // Berechne Deckungsbeitrag
                                                                                updateList[index].dbJePreiseinheit = updateList[index].vkJePreiseinheit - korrekteGesamtSumme;
                                                                                
                                                                                // Berechne Gesamtwerte
                                                                                const anzahlPreiseinheiten = updateList[index].mengeNum / updateList[index].einheit;
                                                                                updateList[index].dbGesamt = updateList[index].dbJePreiseinheit * anzahlPreiseinheiten;
                                                                                updateList[index].gesamtVK = updateList[index].vkJePreiseinheit * anzahlPreiseinheiten;
                                                                                
                                                                                // Wichtig: bei Änderung des Aufschlags den exactUserVkValue aktualisieren,
                                                                                // damit beide Werte synchron sind
                                                                                updateList[index].exactUserVkValue = updateList[index].vkJePreiseinheit;
                                                                                updateList[index].originalAufschlag = newValue;

                                                                                // Sofort aktualisieren für Echtzeitberechnung
                                                                                setArtikelListe(updateList);
                                                                                berechneSendungsVersandkosten();
                                                                                setDummyState(s => s + 1);
                                                                            }
                                                                        }}
                                                                        onKeyDown={(e) => {
                                                                            // Bei Enter-Taste Fokus entfernen (Bestätigung)
                                                                            if (e.key === 'Enter') {
                                                                                e.target.blur();
                                                                            }
                                                                        }}
                                                                        onBlur={(e) => {
                                                                            // Beim Verlassen des Feldes den Wert formatieren
                                                                            const updateList = [...artikelListe];
                                                                            // Temporäres Feld löschen und formatierten Wert zeigen
                                                                            delete updateList[index].tempAufschlagValue;
                                                                            
                                                                            // Wichtig: Bei 0% Aufschlag sicherstellen, dass VK = EK mit Fracht ist
                                                                            if (updateList[index].aufschlagProzent === 0) {
                                                                                // Berechne korrekten EK mit Fracht
                                                                                const basisEK = artikel.ekJePreiseinheit || 0;
                                                                                const frachtKosten = artikel.frachtProEinheit || 0;
                                                                                const lagerKosten = artikel.lagerkostenProEinheit || 0;
                                                                                const korrekteGesamtSumme = basisEK + frachtKosten + lagerKosten;
                                                                                
                                                                                // Aktualisiere Werte
                                                                                updateList[index].ekJePreiseinheitMitFracht = korrekteGesamtSumme;
                                                                                updateList[index].vkJePreiseinheit = korrekteGesamtSumme;
                                                                                updateList[index].exactUserVkValue = korrekteGesamtSumme;
                                                                                
                                                                                // Neu berechnen der Verkaufssumme und des DB
                                                                                const anzahlPreiseinheiten = updateList[index].mengeNum / updateList[index].einheit;
                                                                                updateList[index].gesamtVK = korrekteGesamtSumme * anzahlPreiseinheiten;
                                                                                updateList[index].dbJePreiseinheit = 0; // DB ist 0 bei 0% Aufschlag
                                                                                updateList[index].dbGesamt = 0;
                                                                            }
                                                                            
                                                                            setArtikelListe(updateList);
                                                                            setDummyState(s => s + 1); // Force re-render
                                                                        }}
                                                                        style={{
                                                                            width: '80px', 
                                                                            border: '1px solid #ced4da', 
                                                                            borderRadius: '4px', 
                                                                            padding: '1px 4px',
                                                                            textAlign: 'center',
                                                                            fontSize: '0.85rem'
                                                                        }}
                                                                    />
                                                                </div>
                                                            </td>
                                                            <td style={{padding: '3px 2px', width: '100px', fontSize: '0.85rem', borderRight: '1px solid #dee2e6', textAlign: 'center'}}>{artikel.anteiligeFracht > 0 ? `€${formatDE(artikel.anteiligeFracht)}` : '-'}</td>
                                                            <td style={{padding: '3px 2px', width: '120px', fontSize: '0.85rem', borderRight: '1px solid #dee2e6', textAlign: 'center'}}>€{formatDE(artikel.dbGesamt)}</td>
                                                            <td style={{padding: '4px 4px', textAlign: 'center'}}>
                                                                                                                                    <button 
                                                                    className="btn btn-sm btn-danger"
                                                                                                                                            onClick={() => removeArtikel(index)}
                                                                        style={{borderRadius: '3px', padding: '1px 6px', fontSize: '0.8rem', margin: '0 auto', display: 'block'}}
                                                                    >
                                                                    <i className="bi bi-trash"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                            

                        </div>
                    ) : (
                        <div className="w-100" style={{maxWidth: '1350px', position: 'relative'}}>
                            {/* Datenbank-Tab Inhalt */}
                            <DatabaseTable />
                        </div>
                    )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
    
    <!-- Toggle-Funktion für den Hilfe-Dialog -->
    <script>
    function toggleHilfeDialog() {
        const modal = document.getElementById('hilfeModal');
        if (modal.style.display === 'none' || modal.style.display === '') {
            modal.style.display = 'block'; 
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.style.zIndex = '2000';
            modal.style.paddingTop = '50px';
            modal.classList.remove('fade');
            modal.classList.add('show');
        } else {
            modal.style.display = 'none';
            modal.classList.remove('show');
        }
    }
    </script>

    <script>
    // Funktion zum Ein-/Ausklappen der Accordion-Elemente
    function toggleAccordion(id) {
        const element = document.getElementById(id);
        if (element) {
            // Alle anderen Elemente schließen
            const allCollapses = document.querySelectorAll('.accordion-collapse');
            allCollapses.forEach(collapse => {
                if (collapse.id !== id) {
                    collapse.classList.remove('show');
                    
                    // Finde den zugehörigen Button und setze collapsed-Klasse
                    const buttonSelector = `[onclick*='${collapse.id}']`;
                    const button = document.querySelector(buttonSelector);
                    if (button) button.classList.add('collapsed');
                }
            });
            
            // Das angeklickte Element umschalten
            const isCollapsed = !element.classList.contains('show');
            element.classList.toggle('show');
            
            // Button-Zustand aktualisieren
            const button = document.querySelector(`[onclick*='${id}']`);
            if (button) {
                if (isCollapsed) {
                    button.classList.remove('collapsed');
                } else {
                    button.classList.add('collapsed');
                }
            }
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const loggedInUser = localStorage.getItem('loggedInUser');
        if (loggedInUser) {
            const usernameDisplay = loggedInUser.charAt(0).toUpperCase() + loggedInUser.slice(1);
            const userNameSpan = document.getElementById('userName');
            if (userNameSpan) userNameSpan.textContent = usernameDisplay;
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) userAvatar.src = avatarMap[loggedInUser.toLowerCase()] || 'https://randomuser.me/api/portraits/lego/1.jpg';
        }
        
        // Das erste Accordion-Element öffnen
        const firstAccordion = document.getElementById('collapseOne');
        if (firstAccordion) {
            firstAccordion.classList.add('show');
        }
    });
    </script>

    <!-- Dashboard JavaScript -->
    <script>
    // Dashboard-Variablen werden im Kopfbereich definiert

    function toggleDashboard() {
        const modal = document.getElementById('dashboardModal');
        if (modal.style.display === 'none' || modal.style.display === '') {
            modal.style.display = 'block';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.style.zIndex = '2000';
            modal.style.paddingTop = '50px';
            modal.classList.remove('fade');
            modal.classList.add('show');
            
            // Daten laden
            loadDashboardData();
            
            // Auch die Kundendaten vorausladen
            loadCustomerData();
            
            // Tab-Funktionalität initialisieren
            const tabButtons = document.querySelectorAll('#dashboardTabs .nav-link');
            tabButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    console.log("Tab clicked:", this.getAttribute('data-bs-target'));
                    
                    // Alle Tabs deaktivieren
                    document.querySelectorAll('#dashboardTabs .nav-link').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });
                    
                    // Aktiven Tab setzen
                    this.classList.add('active');
                    const target = document.querySelector(this.getAttribute('data-bs-target'));
                    if (target) {
                        target.classList.add('show', 'active');
                        
                        // Wenn der Kundenauswertungs-Tab geöffnet wird, lade die Kundendaten
                        if (this.getAttribute('data-bs-target') === '#customer') {
                            console.log("Kundenanalyse Tab aktiviert - lade Daten...");
                            loadCustomerData().catch(error => {
                                console.error("Fehler beim Laden der Kundenanalyse:", error);
                            });
                        }
                    } else {
                        console.error("Tab target not found:", this.getAttribute('data-bs-target'));
                    }
                });
            });
            
            // Activate overview tab by default
            const overviewTab = document.getElementById('overview-tab');
            if (overviewTab) {
                overviewTab.classList.add('active');
                const overviewPane = document.getElementById('overview');
                if (overviewPane) {
                    overviewPane.classList.add('show', 'active');
                }
            }
        } else {
            modal.style.display = 'none';
            modal.classList.remove('show');
            
            // Optional: Charts beim Schließen zerstören
            if (window.revenueChart) {
                console.log("Destroying existing revenueChart");
                revenueChart.destroy();
                revenueChart = null;
            }
            if (window.monthlySalesChart) {
                console.log("Destroying existing monthlySalesChart");
                monthlySalesChart.destroy();
                monthlySalesChart = null;
            }
        }
    }

    // Tab functionality now initialized in toggleDashboard function

    async function loadDashboardData() {
        try {
            console.log("Loading dashboard data...");
            
            // Bestehende Charts zerstören, wenn vorhanden
            if (revenueChart) {
                console.log("Destroying existing revenueChart");
                revenueChart.destroy();
                revenueChart = null;
            }
            if (monthlySalesChart) {
                console.log("Destroying existing monthlySalesChart");
                monthlySalesChart.destroy();
                monthlySalesChart = null;
            }
            
            // Bessere Fehlerbehandlung mit Statusprüfung
            console.log("Fetching data from API:", API_URL);
            const response = await fetch(API_URL);
            if (!response.ok) {
                throw new Error(`HTTP Fehler! Status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log("Data received:", data.length, "records");

            
            if (!data || data.length === 0) {
                console.log("No data available, displaying zeros");
                document.getElementById('totalCalculations').textContent = "0";
                document.getElementById('totalRevenue').textContent = "0,00 €";
                document.getElementById('averageMargin').textContent = "0,0%";
                document.getElementById('uniqueCustomers').textContent = "0";
                return;
            }
            
            // Sicherstellen, dass wir mit dem richtigen Datenformat arbeiten
            let artikelArray = [];
            
            // Extrahieren aller Artikel aus allen Kalkulationen
            data.forEach(kalk => {
                if (kalk.artikel && Array.isArray(kalk.artikel)) {
                    artikelArray = artikelArray.concat(kalk.artikel);
                } else if (typeof kalk === 'object') {
                    // Falls die Daten direkt als Artikel kommen
                    artikelArray.push(kalk);
                }
            });
            

            
            // KPIs berechnen
            const totalCalculations = data.length;
            
            // Umsatz aus allen Artikeln berechnen
            let totalRevenue = 0;
            let totalMargin = 0;
            const customers = new Set();
            
            artikelArray.forEach(art => {
                // Sicherstellen, dass die Feldnamen korrekt sind
                const verkaufssumme = parseFloat(art.verkaufssumme || art.gesamtVK || 0) || 0;
                const dbGesamt = parseFloat(art.db_gesamt || art.dbGesamt || 0) || 0;
                
                totalRevenue += verkaufssumme;
                totalMargin += dbGesamt;
                
                if (art.kundenname) {
                    customers.add(art.kundenname);
                }
            });
            
            const avgMarginPercent = totalRevenue > 0 ? (totalMargin / totalRevenue) * 100 : 0;
            
            // KPIs in UI aktualisieren
            document.getElementById('totalCalculations').textContent = totalCalculations;
                            document.getElementById('totalRevenue').textContent = formatCurrencyNoDecimals(totalRevenue);
            document.getElementById('averageMargin').textContent = `${avgMarginPercent.toFixed(1)}%`;
            document.getElementById('uniqueCustomers').textContent = customers.size;
            
            // Top 5 Kunden
            const customerRevenues = {};
            data.forEach(kalk => {
                if (kalk.artikel && Array.isArray(kalk.artikel)) {
                    kalk.artikel.forEach(art => {
                        const kundenname = art.kundenname;
                        const verkaufssumme = parseFloat(art.verkaufssumme) || 0;
                        
                        if (kundenname) {
                            if (!customerRevenues[kundenname]) {
                                customerRevenues[kundenname] = 0;
                            }
                            customerRevenues[kundenname] += verkaufssumme;
                        }
                    });
                }
            });
            
            const sortedCustomers = Object.entries(customerRevenues)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const topCustomersContainer = document.getElementById('topCustomers');
            topCustomersContainer.innerHTML = '';
            
            sortedCustomers.forEach(([customer, revenue]) => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <span>${customer}</span>
                    <span class="badge bg-primary rounded-pill">${formatCurrency(revenue)}</span>
                `;
                topCustomersContainer.appendChild(item);
            });
            
            // Umsatz nach Monaten Chart erstellen
            const monthlyRevenue = Array(12).fill(0);

            data.forEach(kalk => {
                // Direktes Datum-Parsing mit Fallback auf aktuelles Datum
                let date = new Date();
                let month = date.getMonth();
                
                try {
                    // Erst versuchen, datum direkt zu verwenden
                    if (kalk.datum) {
                        const tempDate = new Date(kalk.datum);
                        if (!isNaN(tempDate.getTime())) {
                            date = tempDate;
                            month = date.getMonth();
                        }
                    }
                } catch (e) {
                    console.log("Datumsfehler, verwende aktuellen Monat:", e);
                }
                
                // Stattdessen die Umsätze direkt zuordnen
                if (kalk.artikel && Array.isArray(kalk.artikel)) {
                    kalk.artikel.forEach(art => {
                        const verkaufssumme = parseFloat(art.verkaufssumme || 0) || 
                                            parseFloat(art.gesamtVK || 0) || 0;
                        
                        
                        
                        // Umsatz dem Monat zuordnen
                        monthlyRevenue[month] += verkaufssumme;
                    });
                }
            });


            
            const monthNames = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            
            console.log("Creating revenue chart...");
            const revenueChartCanvas = document.getElementById('revenueChart');
            if (!revenueChartCanvas) {
                console.error("Canvas element 'revenueChart' not found!");
            } else {
                try {
                    // Bei der Chart-Erstellung, speichere die Referenzen
                    revenueChart = new Chart(revenueChartCanvas, {
                        type: 'bar',
                        data: {
                            labels: monthNames,
                            datasets: [{
                                label: 'Umsatz',
                                data: monthlyRevenue,
                                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    console.log("Revenue chart created successfully");
                } catch (err) {
                    console.error("Error creating revenue chart:", err);
                }
            }
            
                            // Verbesserte Kundenanalysetabelle erstellen
                console.log("Erstelle Kundenanalysetabelle...");
                
                // Kundendaten aus allen Artikeln direkt in der API-Antwort extrahieren
                const customerData = {};
                
                // Durchsuche alle Kalkulationen und deren Artikel
                data.forEach(kalk => {
                    try {
                        // Datum aus der Kalkulation extrahieren
                        let kalkDate = new Date();
                        if (kalk.datum) {
                            try {
                                const tempDate = new Date(kalk.datum);
                                if (!isNaN(tempDate.getTime())) {
                                    kalkDate = tempDate;
                                }
                            } catch (error) {
                                console.error("Fehler beim Datum-Parsing:", error);
                            }
                        }
                        
                        // Artikel aus der Kalkulation extrahieren
                        let artikelListe = [];
                        if (kalk.artikelListe && Array.isArray(kalk.artikelListe)) {
                            artikelListe = kalk.artikelListe;
                        } else if (kalk.artikel && Array.isArray(kalk.artikel)) {
                            artikelListe = kalk.artikel;
                        }
                        
                        // Jeden Artikel verarbeiten
                        artikelListe.forEach(art => {
                            // Verschiedene Möglichkeiten für Kundennamen prüfen
                            const kundenname = art.kundenname || kalk.kunde || 'Unbekannter Kunde';
                            
                            // Umsatz- und DB-Werte mit Fallbacks extrahieren
                            const verkaufssumme = parseFloat(art.verkaufssumme || art.gesamtVK || 0) || 0;
                            const dbGesamt = parseFloat(art.db_gesamt || art.dbGesamt || 0) || 0;
                            
                            console.log(`Artikel gefunden für Kunde ${kundenname}, Umsatz: ${verkaufssumme}`);
                            
                            // Kundendaten initialisieren falls noch nicht vorhanden
                            if (!customerData[kundenname]) {
                                customerData[kundenname] = {
                                    offerCount: 0,
                                    totalRevenue: 0,
                                    totalMargin: 0,
                                    lastOfferDate: null
                                };
                            }
                            
                            // Daten aktualisieren
                            customerData[kundenname].offerCount++;
                            customerData[kundenname].totalRevenue += verkaufssumme;
                            customerData[kundenname].totalMargin += dbGesamt;
                            
                            if (!customerData[kundenname].lastOfferDate || kalkDate > customerData[kundenname].lastOfferDate) {
                                customerData[kundenname].lastOfferDate = kalkDate;
                            }
                        });
                    } catch (error) {
                        console.error("Fehler bei der Verarbeitung einer Kalkulation:", error);
                    }
                });
                
                // Wenn keine Kundendaten gefunden wurden, versuche direkt die artikelArray zu verwenden
                if (Object.keys(customerData).length === 0) {
                    console.log("Keine Kundendaten in Kalkulationen gefunden, versuche alternativ artikelArray...");
                    
                    artikelArray.forEach(art => {
                        if (!art.kundenname) return;
                        
                        const verkaufssumme = parseFloat(art.verkaufssumme || art.gesamtVK || 0) || 0;
                        const dbGesamt = parseFloat(art.db_gesamt || art.dbGesamt || 0) || 0;
                        
                        if (!customerData[art.kundenname]) {
                            customerData[art.kundenname] = {
                                offerCount: 0,
                                totalRevenue: 0,
                                totalMargin: 0,
                                lastOfferDate: new Date()
                            };
                        }
                        
                        customerData[art.kundenname].offerCount++;
                        customerData[art.kundenname].totalRevenue += verkaufssumme;
                        customerData[art.kundenname].totalMargin += dbGesamt;
                    });
                }
                
                // Für Testzwecke: Wenn immer noch keine Daten gefunden wurden, erzeuge Dummy-Daten
                if (Object.keys(customerData).length === 0) {
                    console.log("Keine Kundendaten gefunden, erzeuge Dummy-Daten für Test...");
                    customerData["Mustermann GmbH"] = {
                        offerCount: 3,
                        totalRevenue: 12500,
                        totalMargin: 3750,
                        lastOfferDate: new Date()
                    };
                    customerData["Beispiel AG"] = {
                        offerCount: 2,
                        totalRevenue: 8200,
                        totalMargin: 2050,
                        lastOfferDate: new Date()
                    };
                }
                
                console.log("Kundendaten gesammelt:", Object.keys(customerData).length, "Kunden");
                
                // Tabelle leeren und neu befüllen
                const customerTable = document.getElementById('customerTable');
                if (customerTable) {
                    customerTable.innerHTML = '';
                    
                    if (Object.keys(customerData).length === 0) {
                        // Falls keine Kundendaten vorhanden sind, eine Info-Zeile einfügen
                        const emptyRow = document.createElement('tr');
                        emptyRow.innerHTML = `
                            <td colspan="6" class="text-center">Keine Kundendaten verfügbar</td>
                        `;
                        customerTable.appendChild(emptyRow);
                    } else {
                        // Kundendaten in die Tabelle einfügen
                        Object.entries(customerData).forEach(([customer, data]) => {
                            const avgMarginPercent = data.totalRevenue > 0 ? (data.totalMargin / data.totalRevenue) * 100 : 0;
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${customer}</td>
                                <td>${data.offerCount}</td>
                                <td>${formatCurrency(data.totalRevenue)}</td>
                                <td>${avgMarginPercent.toFixed(1)}%</td>
                                <td>${formatDate(data.lastOfferDate)}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" title="Details anzeigen">
                                        <i class="bi bi-info-circle"></i>
                                    </button>
                                </td>
                            `;
                            customerTable.appendChild(row);
                        });
                    }
                } else {
                    console.error("Element 'customerTable' nicht gefunden!");
                }
                
                // Umsatzstatistik Tab befüllen
                console.log("Befülle Umsatzstatistik-Tab...");
                const years = [];
                
                // Aktuelles Jahr hinzufügen, falls keine Daten vorhanden sind
                const currentYear = new Date().getFullYear();
                years.push(currentYear);
                
                // Jahre aus den Daten extrahieren
                data.forEach(kalk => {
                    try {
                        if (kalk.datum) {
                            const year = new Date(kalk.datum).getFullYear();
                            if (!isNaN(year) && !years.includes(year)) {
                                years.push(year);
                            }
                        }
                    } catch (e) {
                        console.error("Fehler beim Extrahieren des Jahres:", e);
                    }
                });
                
                // Zusätzlich Jahre aus dem artikelArray extrahieren (für den Fall, dass die Datumsfelder dort sind)
                artikelArray.forEach(art => {
                    try {
                        if (art.datum) {
                            const year = new Date(art.datum).getFullYear();
                            if (!isNaN(year) && !years.includes(year)) {
                                years.push(year);
                            }
                        }
                    } catch (e) {
                        // Ignorieren
                    }
                });
                
                // Dummy-Jahre für Tests hinzufügen, wenn keine Jahre gefunden wurden
                if (years.length <= 1) {
                    if (!years.includes(currentYear - 1)) years.push(currentYear - 1);
                    if (!years.includes(currentYear - 2)) years.push(currentYear - 2);
                }
                
                years.sort((a, b) => b - a); // Nach Jahren absteigend sortieren
                console.log("Verfügbare Jahre für Filter:", years);
                
                const yearFilter = document.getElementById('yearFilter');
                if (yearFilter) {
                    yearFilter.innerHTML = '';
                    
                    // Alle Jahre Option
                    const allOption = document.createElement('option');
                    allOption.value = 'all';
                    allOption.textContent = 'Alle Jahre';
                    yearFilter.appendChild(allOption);
                    
                    // Jahre einfügen
                    years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        yearFilter.appendChild(option);
                    });
                } else {
                    console.error("Element 'yearFilter' nicht gefunden!");
                }
            
            // Event-Listener für den Filter-Button hinzufügen
            const applyFilterButton = document.getElementById('applyFilter');
            if (applyFilterButton) {
                applyFilterButton.addEventListener('click', function() {
                    // Ausgewähltes Jahr abrufen
                    const selectedYear = yearFilter ? yearFilter.value : 'all';
                    console.log("Filter anwenden für Jahr:", selectedYear);
                    
                    // Filtere Daten nach Jahr
                    let filteredData = data;
                    if (selectedYear !== 'all') {
                        const selectedYearNum = parseInt(selectedYear);
                        filteredData = data.filter(kalk => {
                            if (kalk.datum) {
                                try {
                                    const year = new Date(kalk.datum).getFullYear();
                                    return year === selectedYearNum;
                                } catch (e) {
                                    return false;
                                }
                            }
                            return false;
                        });
                        
                        console.log(`Gefilterte Daten für Jahr ${selectedYearNum}:`, filteredData.length, "Datensätze");
                    }
                    
                    // Monatlicher Umsatz für gefilterte Daten berechnen
                    const filteredMonthlyRevenue = Array(12).fill(0);
                    
                    // Wenn keine gefilterten Daten vorhanden sind, versuche die Artikel direkt zu filtern
                    if (filteredData.length === 0 && selectedYear !== 'all') {
                        console.log("Keine Kalkulationen für dieses Jahr gefunden, versuche Artikel direkt zu filtern");
                        const selectedYearNum = parseInt(selectedYear);
                        
                        artikelArray.forEach(art => {
                            if (art.datum) {
                                try {
                                    const date = new Date(art.datum);
                                    if (!isNaN(date.getTime())) {
                                        const year = date.getFullYear();
                                        const month = date.getMonth();
                                        
                                        if (year === selectedYearNum) {
                                            const verkaufssumme = parseFloat(art.verkaufssumme || art.gesamtVK || 0) || 0;
                                            filteredMonthlyRevenue[month] += verkaufssumme;
                                        }
                                    }
                                } catch (e) {
                                    // Ignorieren
                                }
                            }
                        });
                    } else {
                        // Normale Verarbeitung von Kalkulationen
                        filteredData.forEach(kalk => {
                            let date = new Date();
                            let month = date.getMonth();
                            
                            try {
                                if (kalk.datum) {
                                    const tempDate = new Date(kalk.datum);
                                    if (!isNaN(tempDate.getTime())) {
                                        date = tempDate;
                                        month = date.getMonth();
                                    }
                                }
                            } catch (e) {
                                console.log("Datumsfehler beim Filtern, verwende aktuellen Monat:", e);
                            }
                            
                            if (kalk.artikel && Array.isArray(kalk.artikel)) {
                                kalk.artikel.forEach(art => {
                                    const verkaufssumme = parseFloat(art.verkaufssumme || 0) || 
                                                        parseFloat(art.gesamtVK || 0) || 0;
                                    
                                    filteredMonthlyRevenue[month] += verkaufssumme;
                                });
                            }
                        });
                    }
                    
                    // Chart aktualisieren
                    if (window.monthlySalesChart) {
                        window.monthlySalesChart.data.datasets[0].data = filteredMonthlyRevenue;
                        window.monthlySalesChart.update();
                        console.log("Chart aktualisiert mit gefilterten Daten:", filteredMonthlyRevenue);
                    } else {
                        console.error("monthlySalesChart nicht gefunden!");
                    }
                    
                    // Automatischen Filter beim Laden anwenden
                    document.getElementById('sales-tab').addEventListener('click', function() {
                        setTimeout(() => {
                            applyFilterButton.click(); // Automatisch Filter anwenden
                        }, 500);
                    });
                });
                
                // Sofort Filter anwenden, wenn das Dashboard geladen wird
                setTimeout(() => {
                    applyFilterButton.click();
                }, 1000);
            } else {
                console.error("Element 'applyFilter' nicht gefunden!");
            }
            
            // Umsatz nach Monaten für Umsatzstatistik
            console.log("Creating monthly sales chart...");
            const monthlySalesChartCanvas = document.getElementById('monthlySalesChart');
            if (!monthlySalesChartCanvas) {
                console.error("Canvas element 'monthlySalesChart' not found!");
            } else {
                try {
                    monthlySalesChart = new Chart(monthlySalesChartCanvas, {
                        type: 'bar',
                        data: {
                            labels: monthNames,
                            datasets: [{
                                label: 'Umsatz',
                                data: monthlyRevenue,
                                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    console.log("Monthly sales chart created successfully");
                } catch (err) {
                    console.error("Error creating monthly sales chart:", err);
                }
            }
            
        } catch (error) {
            console.error('Fehler beim Laden der Dashboard-Daten:', error);
            
            // Check if Chart.js is properly loaded
            if (typeof Chart === 'undefined') {
                console.error("Chart.js is not loaded! Make sure the script is imported correctly.");
                alert("Fehler: Chart.js konnte nicht geladen werden. Bitte laden Sie die Seite neu.");
            } else {
                console.log("Chart.js is available:", Chart.version);
            }
            
            // Check if canvas elements exist
            const revenueChartCanvas = document.getElementById('revenueChart');
            const monthlySalesChartCanvas = document.getElementById('monthlySalesChart');
            console.log("Canvas elements: revenueChart=", revenueChartCanvas, "monthlySalesChart=", monthlySalesChartCanvas);
            
            // Genauere Fehlermeldung anzeigen
            const errorMsg = error.message || 'Unbekannter Fehler';
            console.error(`Detaillierter Fehler: ${errorMsg}`);
            console.error("Stack trace:", error.stack);
            
            // Leere Werte anzeigen
            document.getElementById('totalCalculations').textContent = "-";
            document.getElementById('totalRevenue').textContent = "-";
            document.getElementById('averageMargin').textContent = "-";
            document.getElementById('uniqueCustomers').textContent = "-";
        }
    }

    // Hilfsfunktion für Währungsformatierung
    function formatCurrency(value) {
        return new Intl.NumberFormat('de-DE', { 
            style: 'currency', 
            currency: 'EUR',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);
    }

    // Hilfsfunktion für Datumsformatierung, keine Fehler verursachen
    function formatDate(date) {
        try {
            if (!date) return '-';
            
            // Sicherstellen, dass wir ein Date-Objekt haben
            let dateObj;
            if (!(date instanceof Date)) {
                dateObj = new Date(date);
            } else {
                dateObj = date;
            }
            
            // Wenn das Datum ungültig ist, ein Standarddatum zurückgeben
            if (isNaN(dateObj.getTime())) {
                return '-';
            }
            
            // Mit deutscher Formatierung darstellen
            return dateObj.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        } catch (e) {
            console.error("Fehler bei der Datumsformatierung:", e);
            return '-';
        }
    }

    // Verbessere die findDateField Funktion, um auch String-Daten zu erkennen und zu konvertieren
    function findDateField(obj) {
        
        
        const possibleDateFields = ['datum', 'date', 'created_at', 'createdAt', 'timestamp', 'erstelltAm'];
        
        // Prüfe exakte Felder
        for (const field of possibleDateFields) {
            if (obj[field]) {

                return obj[field];
            }
        }
        
        // Wenn kein Feld gefunden wurde, verwenden wir ein aktuelles Datum

        return new Date().toISOString();
    }

    // In der Date-Konvertierungsfunktion die Erkennung verbessern
    function parseDate(dateValue) {
        if (!dateValue) return null;
        

        
        if (dateValue instanceof Date) return dateValue;
        
        if (typeof dateValue === 'string') {
            // Versuche verschiedene Formate zu parsen
            try {
                // Für ISO-Format
                const isoDate = new Date(dateValue);
                if (!isNaN(isoDate.getTime())) return isoDate;
                
                // Für deutsches Format TT.MM.JJJJ
                if (dateValue.match(/^\d{2}\.\d{2}\.\d{4}/)) {
                    const [day, month, year] = dateValue.split('.').map(n => parseInt(n));
                    const germanDate = new Date(year, month - 1, day);
                    if (!isNaN(germanDate.getTime())) return germanDate;
                }
                
                // Füge weitere Formate hinzu, falls notwendig
                
                // Wenn nichts funktioniert hat

                return null;
            } catch (e) {

                return null;
            }
        }
        
        // Für numerische Werte (Timestamp)
        if (typeof dateValue === 'number') {
            return new Date(dateValue);
        }
        
        return null;
    }

        // Lazy-Loading für React
    function App() {
        // States
        const [interneNummer, setInterneNummer] = React.useState("");
        const [kundenname, setKundenname] = React.useState("");
        const [ek, setEk] = React.useState("");
        const [preiseinheit, setPreiseinheit] = React.useState("1000");
        const [menge, setMenge] = React.useState("");
        const [stueckProPalette, setStueckProPalette] = React.useState("");
        const [aufschlag, setAufschlag] = React.useState("");
        const [versandart, setVersandart] = React.useState("lkw");
        const [strecke, setStrecke] = React.useState("");
        const [spedition, setSpedition] = React.useState("");
        const [plz, setPlz] = React.useState("");
        const [lieferantenSkonto, setLieferantenSkonto] = React.useState("2");
        const [skonto, setSkonto] = React.useState("2");
        const [artikelListe, setArtikelListe] = React.useState([]);
        const [gesamtMenge, setGesamtMenge] = React.useState(0);
        const [sendungsVersandkosten, setSendungsVersandkosten] = React.useState(0);
        const [vergleiche, setVergleiche] = React.useState([]);
        const [versandAktiv, setVersandAktiv] = React.useState(false);
        const [lagerPaletten, setLagerPaletten] = React.useState("");
        const [lagerDauer, setLagerDauer] = React.useState("");
        const [lagerGebuehr, setLagerGebuehr] = React.useState(5.5);
        const [dummyState, setDummyState] = React.useState(0);
        const [savedCalculations, setSavedCalculations] = React.useState([]);
        const [searchQuery, setSearchQuery] = React.useState("");
        const [showDatabase, setShowDatabase] = React.useState(false);
        const [adresseFeld, setAdresseFeld] = React.useState("");
        const [entfernungStatus, setEntfernungStatus] = React.useState("");
        const [activeTab, setActiveTab] = React.useState("kalkulation");
        const [behalteKundendaten, setBehalteKundendaten] = React.useState(false);
        const [isLoading, setIsLoading] = React.useState(true);

        // Simuliere Ladezeit
        React.useEffect(() => {
            setTimeout(() => {
                setIsLoading(false);
            }, 300);
        }, []);

        React.useEffect(() => {
            const ekParam = getUrlParam('ek');
            const einheitParam = getUrlParam('einheit');
            const mengeParam = getUrlParam('menge');
            const stkPaletteParam = getUrlParam('stkPalette');
            if (ekParam) setEk(ekParam);
            if (einheitParam) setPreiseinheit(einheitParam);
            if (mengeParam) setMenge(mengeParam);
            if (stkPaletteParam) setStueckProPalette(stkPaletteParam);
        }, []);

        // Versand aktivieren, sobald mindestens ein Artikel in der Sendung ist
        React.useEffect(() => {
            setVersandAktiv(artikelListe.length > 0);
        }, [artikelListe]);

        // Rest des ursprünglichen App-Codes hier einfügen
        // Weitere Funktionen, UI-Komponenten usw.

        // Diese Zeile ist besonders wichtig für die Funktionalität der Anwendung
        function resetForm() {
            setInterneNummer("");
            setKundenname("");
            setEk("");
            setPreiseinheit("1000");
            setMenge("");
            setStueckProPalette("");
            setAufschlag("");
            setVersandart("lkw");
            setStrecke("");
            setSpedition("");
            setPlz("");
            setLieferantenSkonto("2");
            setSkonto("2");
            setArtikelListe([]);
            setGesamtMenge(0);
            setSendungsVersandkosten(0);
            setVergleiche([]);
            setVersandAktiv(false);
            setLagerPaletten("");
            setLagerDauer("");
            setLagerGebuehr(5.5);
            setAdresseFeld("");
            setEntfernungStatus("");
            setBehalteKundendaten(false);
            setDummyState(s => s + 1);
        }

        // Rendert den ursprünglichen Inhalt oder einen Ladeindikator
        if (isLoading) {
            return (
                <div className="loading">
                    <div style={{textAlign: 'center'}}>
                        <div className="spinner-border text-primary" role="status"></div>
                        <p style={{marginTop: '10px'}}>Lade Kalkulation...</p>
                    </div>
                </div>
            );
        }

        // Tab wechseln und Datenbank laden, wenn nötig
        const switchTab = async (tab) => {
            setActiveTab(tab);
            if (tab === "datenbank") {
                await loadKalkulationen();
                setShowDatabase(true);
            } else {
                setShowDatabase(false);
            }
        };

        // Hier den ursprünglichen Return-Teil einfügen, der das UI rendert
        return (
            <div className="main-flex-container">
                <div className="button-leiste">
                    {/* Leere Button-Leiste links */}
                </div>
                
                <div style={{width: '1210px'}}>
                    {/* Tab-Bar über dem Inhalt */}
                    <div style={{marginBottom: '0px'}}>
                        <div className="tab-container" style={{
                            display: 'flex',
                            flexDirection: 'row',
                            marginBottom: '15px',
                            width: '100%',
                            position: 'relative'
                        }}>
                            <button 
                                className={`nav-link ${activeTab === "kalkulation" ? "active" : ""}`} 
                                onClick={() => switchTab("kalkulation")}
                                style={{ 
                                    display: 'inline-block',
                                    width: '170px',
                                    padding: '12px 16px',
                                    background: activeTab === "kalkulation" ? '#1a3b6e' : '#e0e0e0',
                                    color: activeTab === "kalkulation" ? '#fff' : '#333',
                                    fontWeight: 'bold',
                                    border: 'none',
                                    borderRadius: '5px 5px 0 0',
                                    textAlign: 'center',
                                    fontSize: '0.95rem',
                                    outline: 'none',
                                    cursor: 'pointer',
                                    boxShadow: activeTab === "kalkulation" ? '0 -2px 8px rgba(0,0,0,0.1)' : 'none',
                                    marginBottom: 0,
                                    marginRight: '0',
                                    position: 'relative',
                                    zIndex: activeTab === "kalkulation" ? '1' : '0'
                                }}
                            >
                                <i className="bi bi-calculator me-2"></i>Kalkulation
                            </button>
                            <button 
                                className={`nav-link ${activeTab === "datenbank" ? "active" : ""}`} 
                                onClick={() => switchTab("datenbank")}
                                style={{ 
                                    display: 'inline-block',
                                    width: '170px',
                                    padding: '12px 16px',
                                    background: activeTab === "datenbank" ? '#1a3b6e' : '#e0e0e0',
                                    color: activeTab === "datenbank" ? '#fff' : '#333',
                                    fontWeight: 'bold',
                                    border: 'none',
                                    borderRadius: '5px 5px 0 0',
                                    textAlign: 'center',
                                    fontSize: '0.95rem',
                                    outline: 'none',
                                    cursor: 'pointer',
                                    boxShadow: activeTab === "datenbank" ? '0 -2px 8px rgba(0,0,0,0.1)' : 'none',
                                    marginBottom: 0,
                                    marginLeft: '0',
                                    position: 'relative',
                                    zIndex: activeTab === "datenbank" ? '1' : '0'
                                }}
                            >
                                <i className="bi bi-server me-2"></i>Datenbank
                            </button>
                        </div>
                    </div>
                    
                    {/* Hier den Rest des UI-Codes einfügen */}
                    {/* Kalkulation-Tab oder Datenbank-Tab basierend auf activeTab */}
                    
                    {activeTab === "kalkulation" ? (
                        <div className="w-100" style={{maxWidth: '1350px', position: 'relative'}}>
                            <div>Kalkulations-Inhalt wird geladen...</div>
                        </div>
                    ) : (
                        <div className="w-100" style={{maxWidth: '1350px', position: 'relative'}}>
                            <div>Datenbank-Inhalt wird geladen...</div>
                        </div>
                    )}
                </div>
            </div>
        );
    }

    // Rendering nach dem Laden des Dokuments
    document.addEventListener('DOMContentLoaded', function() {
        // React App laden
        setTimeout(() => {
            const root = ReactDOM.createRoot(document.getElementById("root"));
            root.render(<App />);
        }, 100);
    });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');

            if (sidebarToggle && sidebar && mainContent) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('expanded');
                });
            }
        });
    </script>
</body>
</html> 


